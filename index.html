<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è‚ºç™Œè·¯å¾‘">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>å½°æ¿±ç§€å‚³ç™Œç—‡ä¸­å¿ƒ â€” è‚ºç™Œè‡¨åºŠè·¯å¾‘</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f0f2f5;--surface:#fff;--surface2:#f8f9fb;
  --border:#e3e6ec;--border2:#d0d4dc;
  --text:#1a1d23;--text2:#4a5064;--text3:#8890a4;
  --primary:#0d9b6a;--primary-light:#e8f7f1;--primary-dark:#087a54;
  --accent:#2563eb;--accent-light:#eff4ff;
  --amber:#d97706;--amber-light:#fef9ee;--amber-border:#fde68a;
  --rose:#dc2626;--rose-light:#fef2f2;--rose-border:#fecaca;
  --indigo:#4f46e5;--indigo-light:#eef2ff;
  --sidebar:#111827;--sidebar-text:#9ca3af;--sidebar-active:#10b981;
  --radius:10px;--radius-lg:16px;
  --shadow:0 1px 4px rgba(0,0,0,.06);
  --shadow-md:0 4px 16px rgba(0,0,0,.08);
  --transition:all .25s cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden;background:var(--bg)}
body{font-family:'Noto Sans TC',system-ui,sans-serif;color:var(--text);font-size:16px;line-height:1.65;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}
button{font-family:inherit;cursor:pointer;border:none;background:none;font-size:inherit;color:inherit}
input,textarea,select{font-family:inherit;font-size:inherit}

.app{display:flex;height:100vh;height:100dvh}

/* Sidebar */
.sidebar{width:72px;background:var(--sidebar);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:100;flex-shrink:0}
.sidebar .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#34d399);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:#fff;margin-bottom:16px;letter-spacing:-1px}
.sidebar .nav-item{width:52px;height:52px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--sidebar-text);transition:var(--transition);gap:3px;position:relative}
.sidebar .nav-item i{font-size:17px;transition:var(--transition)}
.sidebar .nav-item span{font-size:9px;font-weight:500;opacity:.8;line-height:1}
.sidebar .nav-item:hover{background:rgba(255,255,255,.06)}
.sidebar .nav-item.active{color:#fff;background:rgba(16,185,129,.15)}
.sidebar .nav-item.active::before{content:'';position:absolute;left:-2px;top:50%;transform:translateY(-50%);width:4px;height:24px;border-radius:0 4px 4px 0;background:var(--sidebar-active)}
.sidebar .nav-item.active i{color:var(--sidebar-active)}
.sidebar .spacer{flex:1}
.sidebar .nav-badge{position:absolute;top:6px;right:6px;min-width:16px;height:16px;background:var(--rose);color:#fff;font-size:9px;font-weight:700;border-radius:99px;display:flex;align-items:center;justify-content:center;padding:0 4px}

.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:60px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 28px;gap:16px;flex-shrink:0}
.topbar-title{font-weight:700;font-size:17px;color:var(--text)}
.topbar-title i{color:var(--primary);margin-right:6px}
.topbar .spacer{flex:1}
.topbar-info{font-size:13px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.topbar-btn{height:38px;padding:0 16px;border-radius:8px;font-size:14px;font-weight:600;transition:var(--transition);display:inline-flex;align-items:center;gap:6px}
.topbar-btn.outline{border:1px solid var(--border);color:var(--text2)}
.topbar-btn.outline:hover{background:var(--surface2);border-color:var(--border2)}
.topbar-btn.primary{background:var(--primary);color:#fff}
.topbar-btn.primary:hover{background:var(--primary-dark)}

.content{flex:1;overflow:hidden;position:relative}
.panel{position:absolute;inset:0;padding:28px;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .25s ease;-webkit-overflow-scrolling:touch}
.panel.active{opacity:1;pointer-events:auto}
.panel-inner{max-width:1100px;margin:0 auto}

.bottombar{height:60px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:8px;flex-shrink:0}
.step-dots{display:flex;gap:6px;align-items:center}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:var(--transition)}
.step-dot.active{background:var(--primary);width:24px;border-radius:4px}
.bottombar .spacer{flex:1}
.btn-nav{height:44px;padding:0 24px;border-radius:12px;font-weight:700;font-size:15px;display:inline-flex;align-items:center;gap:7px;transition:var(--transition)}
.btn-nav.back{color:var(--text2);border:1px solid var(--border)}
.btn-nav.back:hover{background:var(--surface2)}
.btn-nav.next{background:var(--primary);color:#fff}
.btn-nav.next:hover{background:var(--primary-dark)}
.btn-nav:disabled{opacity:.3;pointer-events:none}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px}
.card-title{font-size:17px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.card-title i{color:var(--primary)}
.big-btn{min-height:72px;padding:18px 22px;border-radius:var(--radius-lg);border:2px solid var(--border);background:var(--surface);text-align:left;width:100%;transition:var(--transition);display:flex;align-items:center;gap:16px}
.big-btn:hover{border-color:var(--primary);background:var(--primary-light)}
.big-btn.selected{border-color:var(--primary);background:var(--primary-light);box-shadow:0 0 0 3px rgba(13,155,106,.15)}
.big-btn .icon-circle{width:48px;height:48px;border-radius:14px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px}
.big-btn .btn-label{font-weight:700;font-size:16px;line-height:1.3}
.big-btn .btn-desc{font-size:13px;color:var(--text3);margin-top:2px;line-height:1.4}
.badge{display:inline-flex;align-items:center;gap:3px;font-size:12px;font-weight:700;padding:4px 12px;border-radius:99px;white-space:nowrap}
.badge.nhi{background:var(--primary-light);color:var(--primary-dark);border:1px solid #a7f3d0}
.badge.self{background:var(--rose-light);color:var(--rose);border:1px solid var(--rose-border)}
.badge.info{background:var(--accent-light);color:var(--accent);border:1px solid #bfdbfe}
.badge.warn{background:var(--amber-light);color:var(--amber);border:1px solid var(--amber-border)}
.tx-box{padding:14px 18px;border-radius:var(--radius);margin-bottom:8px}
.tx-box.green{background:var(--primary-light);border:1px solid #a7f3d0}
.tx-box.blue{background:var(--accent-light);border:1px solid #bfdbfe}
.tx-box.amber{background:var(--amber-light);border:1px solid var(--amber-border)}
.tx-box.rose{background:var(--rose-light);border:1px solid var(--rose-border)}
.tx-box.gray{background:var(--surface2);border:1px solid var(--border)}
.tx-box.dark{background:var(--sidebar);color:#fff;border:none}
.tx-box h4{font-size:15px;font-weight:700;margin-bottom:6px}
.tx-box p{font-size:14px;line-height:1.6;opacity:.85}
.tx-box .row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:14px}
.tx-box .note{font-size:12px;color:var(--text3);margin-top:8px;font-style:italic}
.tx-box.dark .note{color:rgba(255,255,255,.5)}
#panel-checklist{padding:16px!important;overflow:hidden!important}
.ck-page{height:100%;display:flex;flex-direction:column;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.ck-header{padding:20px 24px 14px;flex-shrink:0;border-bottom:1px solid var(--border)}
.ck-body{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:0;min-height:0}
.ck-col{display:flex;flex-direction:column;padding:10px 16px;overflow:hidden}
.ck-col:first-child{border-right:1px solid var(--border)}
.ck-grp{display:flex;flex-direction:column;flex:1;min-height:0}
.ck-grp-title{font-size:12px;font-weight:700;color:var(--primary);padding:6px 4px 4px;border-bottom:1px solid var(--border);flex-shrink:0;letter-spacing:.3px}
.ck-grp-items{flex:1;display:flex;flex-direction:column;gap:5px;padding:6px 0}
.ck-item{display:flex;align-items:center;gap:12px;padding:0 14px;border-radius:var(--radius);border:1px solid var(--border);transition:var(--transition);cursor:pointer;flex:1;min-height:0}
.ck-item:hover{background:var(--surface2)}
.ck-item.done{background:var(--primary-light);border-color:#a7f3d0}
.ck-item.done .ck-label{text-decoration:line-through;color:var(--text3)}
.ck-box{width:24px;height:24px;border-radius:6px;border:2px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:var(--transition);color:transparent;font-size:13px}
.ck-item.done .ck-box{background:var(--primary);border-color:var(--primary);color:#fff}
.ck-label{font-size:15px;flex:1}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.q-step{margin-bottom:20px}
.q-label{font-size:17px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.q-num{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:8px;background:var(--primary);color:#fff;font-size:13px;font-weight:700;flex-shrink:0}
.q-options{display:grid;gap:8px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;text-align:center}
.stat-card .stat-num{font-size:28px;font-weight:900;color:var(--primary);font-family:'JetBrains Mono',monospace}
.stat-card .stat-label{font-size:12px;color:var(--text3);margin-top:4px}
/* Stats tabbed layout */
#panel-stats{padding:0!important;overflow:hidden!important}
.stat-page{height:100%;display:flex;flex-direction:column;overflow:hidden}
.stat-top{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:16px 24px 8px;flex-wrap:wrap;gap:8px}
.stat-filter{flex-shrink:0;display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:4px 24px 10px}
.sf-date{height:30px;padding:0 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit}
.sf-sel{height:30px;padding:0 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--surface);font-family:inherit}
.stat-tabs{flex-shrink:0;display:flex;gap:4px;padding:0 24px 12px;border-bottom:1px solid var(--border)}
.stat-tab{height:36px;padding:0 16px;border-radius:8px 8px 0 0;font-size:13px;font-weight:600;color:var(--text3);border:1px solid transparent;border-bottom:none;display:inline-flex;align-items:center;gap:6px;transition:var(--transition)}
.stat-tab:hover{color:var(--text);background:var(--surface2)}
.stat-tab.on{color:var(--primary);background:var(--surface);border-color:var(--border);position:relative}
.stat-tab.on::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--surface)}
.stat-content{flex:1;overflow-y:auto;padding:16px 24px;-webkit-overflow-scrolling:touch}
.stat-pane{display:none}
.stat-pane.active{display:block}
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;max-height:320px;display:flex;flex-direction:column}
.chart-wrap h4{font-size:14px;font-weight:700;margin-bottom:8px;flex-shrink:0}
.chart-wrap canvas{flex:1;min-height:0}
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
/* Patient page â€” viewport fill */
#panel-patient{padding:16px!important;overflow:hidden!important}
.pt-page{height:100%;display:flex;flex-direction:column}
.pt-lbl{font-size:14px;font-weight:600;margin-bottom:6px;display:block}
.pt-input{width:100%;height:46px;padding:0 14px;border:2px solid var(--border);border-radius:var(--radius);font-size:15px;background:var(--surface);outline:none;transition:var(--transition)}
.pt-input:focus{border-color:var(--primary)}
/* Pathway â€” 3 column layout */
#panel-pathway{padding:16px!important;overflow:hidden!important}
.pw-layout{height:100%;display:flex;gap:0;border:1px solid var(--border);border-radius:var(--radius-lg);background:var(--surface);overflow:hidden}
.pw-side{width:180px;flex-shrink:0;border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:10px;background:var(--surface2)}
.pw-side-title{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px}
.pw-side-row{display:flex;justify-content:space-between;align-items:center;font-size:15px;padding:5px 0;border-bottom:1px dashed var(--border)}
.pw-side-row:last-child{border:none}
.pw-side-row .l{color:var(--text2);font-size:13px}
.pw-side-row .v{font-weight:700}
.pw-main{flex:1;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch}
.pw-cost{width:240px;flex-shrink:0;border-left:1px solid var(--border);padding:20px;overflow-y:auto;background:var(--surface2)}
.pw-cost-title{font-size:13px;font-weight:700;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.pw-cost-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;font-size:14px;border-bottom:1px dashed var(--border)}
.pw-cost-row:last-child{border:none}
.pw-cost-row .l{color:var(--text2)}
.pw-cost-row .v{font-weight:700;text-align:right;white-space:nowrap}
.empty-state i{font-size:52px;opacity:.3;margin-bottom:16px}
.empty-state h4{font-size:18px;font-weight:700;color:var(--text2);margin-bottom:8px}
.note-area{width:100%;min-height:100px;padding:16px 18px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);resize:vertical;font-size:15px;line-height:1.6;outline:none;transition:var(--transition)}
.note-area:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,155,106,.1)}
.alert-box{padding:16px 20px;border-radius:var(--radius);font-size:14px;line-height:1.6;display:flex;align-items:flex-start;gap:10px}
.alert-box.warn{background:var(--amber-light);border:1px solid var(--amber-border);color:#92400e}
.alert-box.info{background:var(--accent-light);border:1px solid #bfdbfe;color:#1e40af}
.alert-box.danger{background:var(--rose-light);border:1px solid var(--rose-border);color:#991b1b}
.alert-box i{margin-top:2px;flex-shrink:0}
.filter-btn{height:34px;font-size:13px;padding:0 14px;border-radius:7px;border:1px solid var(--border);display:inline-flex;align-items:center;gap:4px;transition:var(--transition)}
.filter-btn:hover{background:var(--surface2)}
.filter-btn.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.ck-stat-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border)}
.ck-stat-row:last-child{border-bottom:none}
.ck-stat-label{width:180px;font-size:13px;flex-shrink:0}
.ck-stat-bar-wrap{flex:1;height:22px;background:var(--surface2);border-radius:6px;overflow:hidden;position:relative}
.ck-stat-bar-fill{height:100%;border-radius:6px;transition:width .6s ease;min-width:2px}
.ck-stat-bar-fill.high{background:var(--primary)}
.ck-stat-bar-fill.mid{background:var(--amber)}
.ck-stat-bar-fill.low{background:var(--rose)}
.ck-stat-pct{width:48px;text-align:right;font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.cross-tbl{width:100%;border-collapse:collapse;font-size:13px}
.cross-tbl th,.cross-tbl td{padding:10px 12px;text-align:center;border:1px solid var(--border)}
.cross-tbl th{background:var(--surface2);font-weight:700;color:var(--text2);font-size:12px}
.cross-tbl td{font-family:'JetBrains Mono',monospace}
.cross-tbl td.hi{background:var(--primary-light);font-weight:700;color:var(--primary-dark)}
.cross-tbl tr:last-child td{font-weight:700;background:var(--surface2)}
.cross-tbl td:last-child{font-weight:700;background:var(--surface2)}

@media(max-width:768px){
  .mob-hide{display:none!important}
  .sidebar{position:fixed;bottom:0;left:0;right:0;height:calc(64px + env(safe-area-inset-bottom,0px));width:100%;flex-direction:row;padding:0 4px;padding-bottom:env(safe-area-inset-bottom,0px);justify-content:space-around;z-index:200;border-top:1px solid rgba(255,255,255,.08)}
  .sidebar .logo,.sidebar .spacer{display:none}
  .sidebar .nav-item{width:auto;flex:1;max-width:56px;height:56px;font-size:9px}
  .sidebar .nav-item i{font-size:18px}
  .sidebar .nav-item.active::before{left:50%;top:-2px;transform:translateX(-50%);width:24px;height:3px;border-radius:0 0 3px 3px}
  .app{flex-direction:column}
  .main{padding-bottom:calc(64px + env(safe-area-inset-bottom,0px))}
  .topbar{padding:0 10px;height:48px;gap:8px}
  .topbar-title{font-size:15px;white-space:nowrap}
  .topbar-info{font-size:11px;white-space:nowrap}
  .topbar-btn{height:36px;width:36px;padding:0;font-size:16px;justify-content:center;border-radius:8px}
  .topbar .spacer{flex:1;min-width:0}
  .panel{padding:12px!important}
  .panel-inner{max-width:100%}
  .grid-2,.grid-3{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .card{padding:14px}
  .card-title{font-size:14px}
  /* Patient form: allow scroll */
  #panel-patient{overflow-y:auto!important;-webkit-overflow-scrolling:touch}
  .pt-page{height:auto;min-height:100%}
  .pt-input{height:42px;font-size:14px}
  .pt-lbl{font-size:13px;margin-bottom:4px}
  /* Checklist: single column, allow scroll */
  #panel-checklist{overflow-y:auto!important;-webkit-overflow-scrolling:touch}
  .ck-page{height:auto;min-height:100%}
  .ck-body{grid-template-columns:1fr;overflow-y:visible}
  .ck-col{border-right:none!important}
  .ck-grp{min-height:auto}
  .ck-item{padding:8px 10px}
  .ck-item label{font-size:13px}
  /* Pathway: stack vertically */
  #panel-pathway{overflow-y:auto!important;-webkit-overflow-scrolling:touch}
  .pw-layout{height:auto;min-height:100%;flex-direction:column}
  .pw-side{width:100%;border-right:none;border-bottom:1px solid var(--border);padding:14px 16px;flex-direction:row;flex-wrap:wrap;gap:6px}
  .pw-side-title{width:100%;margin-bottom:0}
  .pw-side-row{flex:1;min-width:60px;font-size:13px;border-bottom:none;justify-content:center;gap:4px;background:var(--surface);padding:6px 10px;border-radius:var(--radius);border:1px solid var(--border)}
  .pw-main{overflow-y:visible;padding:14px 16px}
  .pw-cost{width:100%;border-left:none;border-top:1px solid var(--border);padding:14px 16px}
  /* Summary: full rewrite for mobile */
  #panel-summary{padding:0!important;overflow-y:auto!important;overflow-x:hidden!important;-webkit-overflow-scrolling:touch}
  .sum-vp{height:auto!important;padding:10px}
  .sum-page{height:auto!important;overflow:visible!important;display:block!important}
  .sum-hdr{padding:12px 16px 10px}
  .sum-org{font-size:14px}
  .sum-dot{margin:0 4px}
  .sum-pt .sp{padding:2px 8px;font-size:13px}
  .sum-pt .sp .l{font-size:10px}
  .sum-cols{display:block!important;overflow:visible!important;height:auto!important}
  .sum-left,.sum-right{display:block!important;overflow:visible!important;height:auto!important}
  .sum-left{border-right:none!important;border-bottom:1px solid var(--border)}
  .sum-sec{display:block!important;padding:10px 16px;overflow:visible!important;height:auto!important}
  .sum-sec.compact{padding:8px 16px}
  .sum-sec.sum-grow{display:block!important;overflow:visible!important;height:auto!important}
  .sck{grid-template-columns:1fr}
  .sr{font-size:13px;padding:5px 0}
  .diag-tag{font-size:13px}
  .diag-tag .l{font-size:10px}
  .st{font-size:13px;margin-bottom:6px}
  .stx .tl{font-size:13px}
  .stx .tv{font-size:14px}
  .snote{font-size:13px}
  .sum-alerts{padding:8px 14px;gap:6px;flex-wrap:wrap}
  .sum-alerts .at{font-size:12px}
  .sum-alerts .ai{font-size:12px}
  .sum-actions{padding:10px 16px;gap:10px}
  .sum-actions .btn-nav{font-size:14px;padding:0 20px!important}
  /* Stats: compact */
  #panel-stats{overflow:hidden!important}
  .stat-top{padding:12px 14px 6px}
  .stat-top h3{font-size:16px}
  .stat-filter{padding:2px 14px 8px;gap:6px}
  .filter-btn{height:30px;font-size:12px;padding:0 10px}
  .stat-tabs{padding:0 14px 8px;gap:2px;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
  .stat-tab{padding:0 10px;font-size:12px;height:32px;white-space:nowrap;flex-shrink:0}
  .stat-content{padding:12px 14px}
  .chart-wrap{max-height:260px;padding:12px}
  .chart-wrap h4{font-size:13px}
  .stat-card .stat-num{font-size:22px}
  .stat-card{padding:10px}
  .ck-stat-label{width:100px;font-size:11px}
  .ck-stat-pct{width:40px;font-size:12px}
  /* Cross table */
  .cross-tbl th,.cross-tbl td{padding:6px 8px;font-size:12px}
  /* Decision tree */
  .dt-dot{width:28px;height:28px;font-size:12px}
  .dt-line{width:20px}
  .big-btn{min-height:48px}
  /* Records */
  .rec-row{padding:10px 12px}
  .rec-row .rec-info{font-size:13px}
  /* Print buttons etc */
  .note-area{font-size:14px}
}
@media(max-width:400px){
  .topbar-info{display:none}
  .topbar-title{font-size:13px}
  .grid-4{grid-template-columns:1fr 1fr}
  .stat-card .stat-num{font-size:20px}
}
/* Decision card-based navigation */
.dt-step-bar{display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:24px}
.dt-dot{width:32px;height:32px;border-radius:50%;background:var(--border);color:var(--text3);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.dt-dot.active{background:var(--primary);color:#fff}
.dt-dot.done{background:var(--primary-light);color:var(--primary);border:2px solid var(--primary)}
.dt-line{width:32px;height:2px;background:var(--border);transition:var(--transition)}
.dt-line.done{background:var(--primary)}
.dt-card{display:none;animation:dtFadeIn .25s ease}
.dt-card.active{display:block}
@keyframes dtFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.dt-back-btn{display:inline-flex;align-items:center;gap:6px;margin-top:20px;padding:10px 20px;border-radius:var(--radius);border:1px solid var(--border);color:var(--text2);font-size:14px;font-weight:500;transition:var(--transition);background:var(--surface)}
.dt-back-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
/* Backup panel */
.rec-row{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);margin-bottom:8px;cursor:pointer;transition:var(--transition)}
.rec-row:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.rec-row .rec-info{flex:1;min-width:0}
.rec-row .rec-title{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600}
.rec-row .rec-meta{font-size:12px;color:var(--text3);margin-top:3px}
.rec-row .rec-date{font-size:11px;color:var(--text3);white-space:nowrap;font-family:'JetBrains Mono',monospace}
.rec-row .rec-del{color:var(--rose);font-size:14px;padding:8px;flex-shrink:0;transition:var(--transition);border-radius:8px}
.rec-row .rec-del:hover{background:var(--rose-light)}
mark{background:#fef08a;border-radius:2px;padding:0 1px}
/* Summary â€” 2-col stacked, NO scroll */
#panel-summary{padding:0!important;overflow:hidden!important}
.sum-vp{height:100%;padding:14px}
.sum-page{height:100%;display:flex;flex-direction:column;border:1px solid var(--border);border-radius:var(--radius-lg);background:var(--surface);overflow:hidden}
.sum-hdr{flex-shrink:0;border-bottom:2px solid var(--primary);padding:12px 28px 10px}
.sum-org{font-size:20px;font-weight:900;text-align:center;margin-bottom:6px}
.sum-dot{margin:0 8px;color:var(--text3);font-weight:400}
.sum-pt{display:flex;flex-wrap:wrap;justify-content:center;gap:0}
.sum-pt .sp{padding:3px 16px;display:flex;align-items:center;gap:5px;font-size:16px}
.sum-pt .sp .l{color:var(--text3);font-size:12px}
.sum-pt .sp .v{font-weight:700}
.sum-cols{flex:1;display:flex;min-height:0;overflow:hidden}
.sum-left,.sum-right{flex:1;display:flex;flex-direction:column;overflow:hidden}
.sum-left{border-right:1px solid var(--border)}
.sum-sec{flex-shrink:0;padding:14px 28px;border-bottom:1px solid var(--border)}
.sum-sec.sum-grow{flex:1;border-bottom:none;overflow:hidden;padding-top:14px}
.sum-sec.compact{padding:10px 28px}
.st{font-size:14px;font-weight:800;color:var(--primary);margin-bottom:10px;display:flex;align-items:center;gap:8px;letter-spacing:.3px}
.st i{font-size:16px}
.sr{display:flex;justify-content:space-between;align-items:center;padding:7px 0;font-size:16px;border-bottom:1px dashed var(--border)}
.sr:last-child{border:none}
.sr .l{color:var(--text2)}
.sr .v{font-weight:700}
.diag-row{display:flex;flex-wrap:wrap;gap:6px 16px}
.diag-tag{font-size:15px;display:flex;align-items:center;gap:5px}
.diag-tag .l{color:var(--text3);font-size:12px}
.diag-tag .v{font-weight:700}
.stx{padding:8px 0;border-bottom:1px dashed var(--border)}
.stx:last-child{border:none}
.stx .tl{font-weight:700;font-size:14px;color:var(--text2);margin-bottom:3px;display:flex;align-items:center;gap:6px}
.stx .tv{font-size:16px;line-height:1.5}
.sbar{height:7px;background:var(--border);border-radius:99px;overflow:hidden;margin-bottom:10px}
.sbar>div{height:100%;border-radius:99px}
.sck{display:grid;grid-template-columns:1fr 1fr;gap:5px 20px}
.sci{font-size:15px;padding:5px 0;display:flex;align-items:center;gap:8px;color:var(--rose)}
.sci i{font-size:13px;width:16px;text-align:center;flex-shrink:0}
.sck-ok{text-align:center;padding:20px 0;color:var(--primary);font-size:18px;font-weight:700}
.sck-ok i{margin-right:6px}
.snote{font-size:15px;color:var(--text2);line-height:1.6;white-space:pre-wrap}
.snote-empty{color:var(--text3);font-size:14px;font-style:italic}
.sum-alerts{flex-shrink:0;border-top:1px solid var(--rose-border);background:var(--rose-light);padding:9px 28px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.sum-alerts .at{font-size:13px;font-weight:700;color:var(--rose);white-space:nowrap;margin-right:2px}
.sum-alerts .ai{font-size:13px;color:#991b1b;display:flex;align-items:center;gap:4px}
.sum-alerts .ai i{font-size:10px;color:var(--rose)}
.sum-alerts .as{color:var(--rose-border)}
.sum-actions{flex-shrink:0;display:flex;gap:14px;justify-content:center;padding:12px 28px;border-top:1px solid var(--border);background:var(--surface2)}
/* summary responsive handled in main @media block */
/* Backup panel */
.bk-card{background:var(--surface);border-radius:var(--radius-lg);border:1px solid var(--border);padding:24px;margin-bottom:16px}
.bk-btn{display:flex;align-items:center;gap:14px;padding:16px 20px;border-radius:var(--radius);border:1px solid var(--border);width:100%;text-align:left;font-size:15px;transition:var(--transition);background:var(--surface);margin-bottom:10px}
.bk-btn:hover{border-color:var(--primary);background:var(--primary-light)}
.bk-btn i{font-size:20px;width:24px;text-align:center;flex-shrink:0}
.bk-btn .bk-desc{font-size:12px;color:var(--text3);margin-top:2px}
@page{size:landscape;margin:8mm}
@media print{
  .sidebar,.topbar,.bottombar{display:none!important}
  .app{display:block}.main{display:block}
  .content{overflow:visible;position:static}
  .panel{position:static;opacity:1;pointer-events:auto;overflow:visible}
  .panel:not(.active){display:none}
  body{overflow:auto;font-size:14px}
  .sum-actions{display:none!important}
  .sum-vp{height:auto;padding:0}
  .sum-page{border:none;height:auto;box-shadow:none}
  .sum-hdr{padding:8px 20px 6px}
  .sum-org{font-size:17px}
  .sum-pt .sp{font-size:13px;padding:2px 12px}
  .sum-cols{overflow:visible}
  .sum-left,.sum-right{overflow:visible}
  .sum-sec{padding:12px 20px;overflow:visible}
  .sr{font-size:14px;padding:5px 0}
  .stx .tv{font-size:14px}
  .sci{font-size:13px}
  .sum-alerts{padding:6px 20px}
}
</style>
</head>
<body>
<div class="app">
  <nav class="sidebar">
    <div class="logo" title="å½°æ¿±ç§€å‚³ç™Œç—‡ä¸­å¿ƒ">ç§€</div>
    <button class="nav-item active" data-panel="patient" onclick="APP.go('patient')"><i class="fa-solid fa-user-pen"></i><span>ç—…äºº</span></button>
    <button class="nav-item" data-panel="checklist" onclick="APP.go('checklist')"><i class="fa-solid fa-clipboard-check"></i><span>æª¢æŸ¥</span><span class="nav-badge" id="ck-badge" style="display:none">0</span></button>
    <button class="nav-item" data-panel="decision" onclick="APP.go('decision')"><i class="fa-solid fa-route"></i><span>æ±ºç­–</span></button>
    <button class="nav-item" data-panel="pathway" onclick="APP.go('pathway')"><i class="fa-solid fa-map"></i><span>è·¯å¾‘</span></button>
    <button class="nav-item" data-panel="summary" onclick="APP.go('summary')"><i class="fa-solid fa-id-card-clip"></i><span>ç¸½è¦½</span></button>
    <div class="spacer"></div>
    <button class="nav-item" data-panel="records" onclick="APP.go('records')"><i class="fa-solid fa-folder-open"></i><span>ç´€éŒ„</span></button>
    <button class="nav-item" data-panel="stats" onclick="APP.go('stats')"><i class="fa-solid fa-chart-pie"></i><span>çµ±è¨ˆ</span></button>
    <button class="nav-item" data-panel="backup" onclick="APP.go('backup')"><i class="fa-solid fa-hard-drive"></i><span>å‚™ä»½</span></button>
  </nav>

  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title"><i class="fa-solid fa-lungs"></i> è‚ºç™Œ<span class="mob-hide">è‡¨åºŠ</span>è·¯å¾‘</div>
      <div class="spacer"></div>
      <span class="topbar-info" id="topbar-date"></span>
      <button class="topbar-btn outline" onclick="window.print()"><i class="fa-solid fa-print"></i><span class="mob-hide"> åˆ—å°</span></button>
      <button class="topbar-btn outline" onclick="APP.newPatient()"><i class="fa-solid fa-plus"></i><span class="mob-hide"> æ–°ç—…äºº</span></button>
    </div>

    <div class="content">

      <!-- â•â•â• PANEL: PATIENT â•â•â• -->
      <div class="panel active" id="panel-patient">
        <div class="pt-page">
          <div class="card" style="flex:1;display:flex;flex-direction:column;padding:20px 28px">
            <div class="card-title" style="margin-bottom:12px"><i class="fa-solid fa-user-pen"></i> ç—…äººè³‡è¨Š</div>
            <div style="display:flex;flex-direction:column;gap:12px;flex:1">
              <div class="grid-2">
                <div>
                  <label class="pt-lbl">ç—…äººä»£è™Ÿ *</label>
                  <input id="pt-code" type="text" placeholder="ä¾‹ï¼šA0012" maxlength="20" class="pt-input" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
                </div>
                <div>
                  <label class="pt-lbl">å§“å</label>
                  <input id="pt-name" type="text" placeholder="ç‹å°æ˜" maxlength="20" class="pt-input" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label class="pt-lbl">æ”¶æ¡ˆæ—¥æœŸ</label>
                  <input id="pt-casedate" type="date" class="pt-input" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'" onchange="APP.calcAge()">
                </div>
                <div>
                  <label class="pt-lbl">å‡ºç”Ÿæ—¥æœŸ</label>
                  <div style="display:flex;align-items:center;gap:10px">
                    <input id="pt-birthday" type="date" class="pt-input" style="flex:1" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'" onchange="APP.calcAge()">
                    <span id="pt-age-display" style="font-size:15px;font-weight:700;color:var(--primary);white-space:nowrap;min-width:48px"></span>
                  </div>
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label class="pt-lbl">æ€§åˆ¥</label>
                  <div style="display:flex;gap:8px">
                    <button class="big-btn gender-btn" data-val="M" onclick="APP.pickGender('M')" style="min-height:44px;justify-content:center;flex:1;padding:8px"><span class="btn-label">ç”·</span></button>
                    <button class="big-btn gender-btn" data-val="F" onclick="APP.pickGender('F')" style="min-height:44px;justify-content:center;flex:1;padding:8px"><span class="btn-label">å¥³</span></button>
                  </div>
                </div>
                <div>
                  <label class="pt-lbl">ECOG</label>
                  <div style="display:flex;gap:6px;flex-wrap:wrap">
                    <button class="big-btn ecog-btn" data-val="0" onclick="APP.pickECOG('0')" style="min-height:44px;flex:1;flex-direction:column;align-items:center;padding:6px"><span class="btn-label" style="font-size:16px">0</span><span class="btn-desc" style="font-size:10px">æ­£å¸¸</span></button>
                    <button class="big-btn ecog-btn" data-val="1" onclick="APP.pickECOG('1')" style="min-height:44px;flex:1;flex-direction:column;align-items:center;padding:6px"><span class="btn-label" style="font-size:16px">1</span><span class="btn-desc" style="font-size:10px">è¼•åº¦</span></button>
                    <button class="big-btn ecog-btn" data-val="2" onclick="APP.pickECOG('2')" style="min-height:44px;flex:1;flex-direction:column;align-items:center;padding:6px"><span class="btn-label" style="font-size:16px">2</span><span class="btn-desc" style="font-size:10px">&lt;50%è‡¥åºŠ</span></button>
                    <button class="big-btn ecog-btn" data-val="3" onclick="APP.pickECOG('3')" style="min-height:44px;flex:1;flex-direction:column;align-items:center;padding:6px"><span class="btn-label" style="font-size:16px">3</span><span class="btn-desc" style="font-size:10px">&gt;50%è‡¥åºŠ</span></button>
                    <button class="big-btn ecog-btn" data-val="4" onclick="APP.pickECOG('4')" style="min-height:44px;flex:1;flex-direction:column;align-items:center;padding:6px"><span class="btn-label" style="font-size:16px">4</span><span class="btn-desc" style="font-size:10px">å…¨è‡¥åºŠ</span></button>
                  </div>
                </div>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;min-height:0">
                <label class="pt-lbl">å‚™è¨»</label>
                <textarea class="note-area" id="pt-notes" placeholder="è¨˜éŒ„æƒ³å•é†«å¸«çš„å•é¡Œã€ç‰¹æ®Šç‹€æ³â€¦" style="flex:1;min-height:60px;resize:none" oninput="APP.S.notes=this.value"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• PANEL: RECORDS â•â•â• -->
      <div class="panel" id="panel-records"><div class="panel-inner">
        <div>
          <!-- Search + filter bar -->
          <div class="card" style="padding:14px 20px;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
              <div style="flex:1;min-width:200px;position:relative">
                <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px"></i>
                <input id="rec-search" type="text" placeholder="æœå°‹ä»£è™Ÿã€å§“åâ€¦" oninput="APP.filterRecords()" style="width:100%;height:40px;padding:0 14px 0 38px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;outline:none;transition:var(--transition)" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
              </div>
              <select id="rec-status" onchange="APP.filterRecords()" style="height:40px;padding:0 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;background:var(--surface)">
                <option value="all">å…¨éƒ¨</option><option value="saved">å·²å­˜æª”</option><option value="draft">è‰ç¨¿</option>
              </select>
              <select id="rec-type" onchange="APP.filterRecords()" style="height:40px;padding:0 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;background:var(--surface)">
                <option value="">å…¨å‹æ…‹</option><option value="AD">è…ºç™Œ</option><option value="SCC">é±—ç™Œ</option><option value="SCLC">å°ç´°èƒ</option>
              </select>
              <select id="rec-stage" onchange="APP.filterRecords()" style="height:40px;padding:0 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;background:var(--surface)">
                <option value="">å…¨åˆ†æœŸ</option><option value="I-II">I-II</option><option value="III">III</option><option value="IV">IV</option><option value="LS">LS</option><option value="ES">ES</option>
              </select>
              <span id="rec-count" style="font-size:12px;color:var(--text3);white-space:nowrap;font-family:'JetBrains Mono',monospace"></span>
            </div>
          </div>
          <!-- Record list -->
          <div id="record-list" style="overflow-y:auto;max-height:calc(100dvh - 200px)"></div>
        </div>
      </div></div>

      <!-- â•â•â• PANEL: DECISION â•â•â• -->
      <div class="panel" id="panel-decision"><div class="panel-inner">
        <!-- Step indicator -->
        <div class="dt-step-bar" id="dt-step-bar">
          <div class="dt-dot active" data-s="1">1</div><div class="dt-line"></div>
          <div class="dt-dot" data-s="2">2</div><div class="dt-line"></div>
          <div class="dt-dot" data-s="3">3</div><div class="dt-line"></div>
          <div class="dt-dot" data-s="4">4</div>
        </div>
        <!-- Cards: only one visible at a time -->
        <div class="dt-card active" id="dt-card-1">
          <div class="card" style="padding:28px 24px">
            <div class="q-label" style="margin-bottom:20px"><span class="q-num">1</span> ç—…ç†å‹æ…‹</div>
            <div class="q-options">
              <button class="big-btn dt-btn" data-q="type" data-val="AD" onclick="APP.dt('type','AD')"><div class="icon-circle" style="background:var(--primary-light);color:var(--primary)"><i class="fa-solid fa-lungs"></i></div><div><div class="btn-label">è‚ºè…ºç™Œ</div><div class="btn-desc">ä½”å°ç£æœ€å¤§å®—ï¼Œæ¨™é¶é¸æ“‡å¤š</div></div></button>
              <button class="big-btn dt-btn" data-q="type" data-val="SCC" onclick="APP.dt('type','SCC')"><div class="icon-circle" style="background:var(--amber-light);color:var(--amber)"><i class="fa-solid fa-shield-halved"></i></div><div><div class="btn-label">é±—ç‹€ä¸Šçš®ç™Œ</div><div class="btn-desc">å¤šèˆ‡å¸è¸ç›¸é—œ</div></div></button>
              <button class="big-btn dt-btn" data-q="type" data-val="SCLC" onclick="APP.dt('type','SCLC')"><div class="icon-circle" style="background:var(--rose-light);color:var(--rose)"><i class="fa-solid fa-bolt"></i></div><div><div class="btn-label">å°ç´°èƒè‚ºç™Œ</div><div class="btn-desc">ç”Ÿé•·å¿«é€Ÿï¼ŒåŒ–æ”¾ç™‚æ•æ„Ÿ</div></div></button>
            </div>
          </div>
        </div>
        <div class="dt-card" id="dt-card-2">
          <div class="card" style="padding:28px 24px">
            <div class="q-label" style="margin-bottom:20px"><span class="q-num">2</span> <span id="q-stage-label">åˆ†æœŸ</span></div>
            <div class="q-options" id="q-stage-opts"></div>
            <button class="dt-back-btn" onclick="APP.dtBack(1)"><i class="fa-solid fa-chevron-left"></i> ä¸Šä¸€é¡Œ</button>
          </div>
        </div>
        <div class="dt-card" id="dt-card-3">
          <div class="card" style="padding:28px 24px">
            <div class="q-label" style="margin-bottom:20px"><span class="q-num">3</span> åŸºå› çªè®Š</div>
            <div class="q-options grid-2">
              <button class="big-btn dt-btn" data-q="mutation" data-val="EGFR" onclick="APP.dt('mutation','EGFR')"><div><div class="btn-label">EGFR</div><div class="btn-desc">æœ€å¸¸è¦‹ 50-60%</div></div></button>
              <button class="big-btn dt-btn" data-q="mutation" data-val="ALK" onclick="APP.dt('mutation','ALK')"><div><div class="btn-label">ALK</div><div class="btn-desc">3-5%</div></div></button>
              <button class="big-btn dt-btn" data-q="mutation" data-val="OTHER" onclick="APP.dt('mutation','OTHER')"><div><div class="btn-label">å…¶ä»–çªè®Š</div><div class="btn-desc">ROS1, BRAF, METâ€¦</div></div></button>
              <button class="big-btn dt-btn" data-q="mutation" data-val="NONE" onclick="APP.dt('mutation','NONE')"><div><div class="btn-label">ç„¡çªè®Š</div><div class="btn-desc">Wild-type</div></div></button>
              <button class="big-btn dt-btn" data-q="mutation" data-val="PENDING" onclick="APP.dt('mutation','PENDING')"><div><div class="btn-label">ç­‰å ±å‘Šä¸­</div></div></button>
            </div>
            <button class="dt-back-btn" onclick="APP.dtBack(2)"><i class="fa-solid fa-chevron-left"></i> ä¸Šä¸€é¡Œ</button>
          </div>
        </div>
        <div class="dt-card" id="dt-card-4">
          <div class="card" style="padding:28px 24px">
            <div class="q-label" style="margin-bottom:20px"><span class="q-num">4</span> PD-L1</div>
            <div class="q-options grid-2">
              <button class="big-btn dt-btn" data-q="pdl1" data-val=">=50" onclick="APP.dt('pdl1','>=50')"><div><div class="btn-label">â‰¥ 50%</div></div></button>
              <button class="big-btn dt-btn" data-q="pdl1" data-val="1-49" onclick="APP.dt('pdl1','1-49')"><div><div class="btn-label">1â€“49%</div></div></button>
              <button class="big-btn dt-btn" data-q="pdl1" data-val="<1" onclick="APP.dt('pdl1','<1')"><div><div class="btn-label">&lt; 1%</div></div></button>
              <button class="big-btn dt-btn" data-q="pdl1" data-val="unknown" onclick="APP.dt('pdl1','unknown')"><div><div class="btn-label">æœªæ¸¬å®š</div></div></button>
            </div>
            <button class="dt-back-btn" onclick="APP.dtBack(3)"><i class="fa-solid fa-chevron-left"></i> ä¸Šä¸€é¡Œ</button>
          </div>
        </div>
        <div class="dt-card" id="dt-card-done">
          <div class="card" style="text-align:center;padding:40px 24px">
            <div style="font-size:48px;margin-bottom:12px">ğŸ¯</div>
            <h3 style="font-size:20px;font-weight:900;margin-bottom:8px">æ±ºç­–å®Œæˆ</h3>
            <p style="color:var(--text3);margin-bottom:24px" id="dt-summary-text"></p>
            <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
              <button class="btn-nav next" onclick="APP.go('pathway')" style="padding:0 28px"><i class="fa-solid fa-map"></i> æŸ¥çœ‹è·¯å¾‘</button>
              <button class="btn-nav back" onclick="APP.dtBack('last')" style="padding:0 28px"><i class="fa-solid fa-pen"></i> ä¿®æ”¹é¸æ“‡</button>
            </div>
          </div>
        </div>
      </div></div>

      <!-- â•â•â• PANEL: PATHWAY â•â•â• -->
      <div class="panel" id="panel-pathway">
        <div id="pw-empty" class="empty-state"><i class="fa-solid fa-route"></i><h4>å°šæœªé¸æ“‡æ±ºç­–</h4><p>è«‹å…ˆè‡³ã€Œæ±ºç­–ã€é å®Œæˆå•ç­”</p></div>
        <div id="pw-wrap" class="pw-layout" style="display:none">
          <div class="pw-side" id="pw-side"></div>
          <div class="pw-main" id="pw-content"></div>
          <div class="pw-cost" id="pw-cost"></div>
        </div>
      </div>

      <!-- â•â•â• PANEL: SUMMARY â•â•â• -->
      <div class="panel" id="panel-summary">
        <div id="sum-empty" class="empty-state"><i class="fa-solid fa-id-card-clip"></i><h4>å°šç„¡ç—…äººè³‡æ–™</h4><p>è«‹å…ˆè‡³ã€Œç—…äººã€é å¡«å¯«åŸºæœ¬è³‡æ–™</p></div>
        <div id="sum-content" class="sum-vp" style="display:none">
          <div class="sum-page">
            <!-- Header -->
            <div class="sum-hdr">
              <div class="sum-org">å½°æ¿±ç§€å‚³ç™Œç—‡ä¸­å¿ƒ<span class="sum-dot">Â·</span>è‚ºç™Œè‡¨åºŠè·¯å¾‘ç¸½è¦½</div>
              <div class="sum-pt" id="sum-patient"></div>
            </div>
            <!-- 2-column body -->
            <div class="sum-cols">
              <div class="sum-left">
                <div class="sum-sec compact" id="sum-diagnosis"></div>
                <div class="sum-sec sum-grow" id="sum-checklist"></div>
              </div>
              <div class="sum-right">
                <div class="sum-sec" id="sum-treatment"></div>
                <div class="sum-sec sum-grow" id="sum-notes-box"></div>
              </div>
            </div>
            <!-- Alerts -->
            <div class="sum-alerts" id="sum-alerts"></div>
            <!-- Actions -->
            <div class="sum-actions">
              <button class="btn-nav next" onclick="APP.save()" style="padding:0 28px"><i class="fa-solid fa-floppy-disk"></i> <span id="sum-save-label">å„²å­˜ç´€éŒ„</span></button>
              <button class="btn-nav back" onclick="APP.printSummary()" style="padding:0 28px"><i class="fa-solid fa-print"></i> åˆ—å°</button>
            </div>
          </div>
        </div>
        <!-- Post-save -->
        <div id="sum-saved" style="display:none">
          <div style="display:flex;align-items:center;justify-content:center;height:100%;padding:40px">
            <div class="card" style="text-align:center;padding:40px 32px;max-width:440px;width:100%">
              <div style="font-size:48px;margin-bottom:16px">âœ…</div>
              <h3 style="font-size:20px;font-weight:900;margin-bottom:8px">ç´€éŒ„å·²å„²å­˜</h3>
              <p style="color:var(--text3);margin-bottom:24px" id="sum-saved-info"></p>
              <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                <button class="btn-nav next" onclick="APP.newPatient()" style="padding:0 24px"><i class="fa-solid fa-plus"></i> æ–°ç—…äºº</button>
                <button class="btn-nav back" onclick="APP.go('records')" style="padding:0 24px"><i class="fa-solid fa-folder-open"></i> ç´€éŒ„åˆ—è¡¨</button>
                <button class="btn-nav back" onclick="APP.continueSummary()" style="padding:0 24px"><i class="fa-solid fa-pen"></i> ç¹¼çºŒç·¨è¼¯</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• PANEL: CHECKLIST â•â•â• -->
      <div class="panel" id="panel-checklist">
        <div class="ck-page">
          <div class="ck-header">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px"><i class="fa-solid fa-clipboard-check" style="color:var(--primary)"></i> è¨ºé–“æª¢æŸ¥è¡¨</div>
              <span id="ck-pct" style="font-size:16px;font-weight:700;color:var(--primary);font-family:'JetBrains Mono',monospace">0%</span>
            </div>
            <div style="height:6px;background:var(--border);border-radius:99px;margin-top:10px;overflow:hidden"><div id="ck-bar" style="height:100%;background:var(--primary);border-radius:99px;width:0%;transition:width .4s"></div></div>
          </div>
          <div class="ck-body" id="ck-list"></div>
        </div>
      </div>

      <!-- â•â•â• PANEL: STATS â•â•â• -->
      <div class="panel" id="panel-stats">
        <div class="stat-page">
          <!-- Top bar: title + export -->
          <div class="stat-top">
            <h3 style="font-size:18px;font-weight:900">çµ±è¨ˆå„€è¡¨æ¿</h3>
            <div style="display:flex;gap:8px">
              <button class="topbar-btn outline" onclick="APP.exportCSV()"><i class="fa-solid fa-file-csv"></i><span class="mob-hide"> CSV</span></button>
              <button class="topbar-btn outline" onclick="APP.exportJSON()"><i class="fa-solid fa-file-code"></i><span class="mob-hide"> JSON</span></button>
            </div>
          </div>
          <!-- Filter bar -->
          <div class="stat-filter">
            <span style="font-size:13px;font-weight:700;color:var(--text3);flex-shrink:0"><i class="fa-solid fa-filter" style="margin-right:4px"></i>ç¯©é¸</span>
            <button class="filter-btn on" data-sf="all" onclick="APP.statRange('all')">å…¨éƒ¨</button>
            <button class="filter-btn" data-sf="month" onclick="APP.statRange('month')">æœ¬æœˆ</button>
            <button class="filter-btn" data-sf="3m" onclick="APP.statRange('3m')">è¿‘ä¸‰æœˆ</button>
            <button class="filter-btn" data-sf="6m" onclick="APP.statRange('6m')">è¿‘åŠå¹´</button>
            <button class="filter-btn" data-sf="year" onclick="APP.statRange('year')">ä»Šå¹´</button>
            <span style="color:var(--border2)">â”‚</span>
            <input type="date" id="sf-from" class="sf-date" onchange="APP.statRange('custom')">
            <span style="font-size:12px;color:var(--text3)">~</span>
            <input type="date" id="sf-to" class="sf-date" onchange="APP.statRange('custom')">
            <span style="color:var(--border2)">â”‚</span>
            <select id="sf-type" class="sf-sel" onchange="APP.statRefresh()">
              <option value="">å…¨å‹æ…‹</option><option value="AD">è…ºç™Œ</option><option value="SCC">é±—ç™Œ</option><option value="SCLC">å°ç´°èƒ</option>
            </select>
            <select id="sf-stage" class="sf-sel" onchange="APP.statRefresh()">
              <option value="">å…¨åˆ†æœŸ</option><option value="I-II">I-II</option><option value="III">III</option><option value="IV">IV</option><option value="LS">LS</option><option value="ES">ES</option>
            </select>
          </div>
          <!-- Tab row -->
          <div class="stat-tabs" id="stat-tabs">
            <button class="stat-tab on" data-st="overview" onclick="APP.statTab('overview')"><i class="fa-solid fa-chart-simple"></i> æ¦‚è¦½</button>
            <button class="stat-tab" data-st="muttrend" onclick="APP.statTab('muttrend')"><i class="fa-solid fa-dna"></i> çªè®Šè¶¨å‹¢</button>
            <button class="stat-tab" data-st="checklist" onclick="APP.statTab('checklist')"><i class="fa-solid fa-clipboard-check"></i> æª¢æŸ¥åˆ†æ</button>
            <button class="stat-tab" data-st="cross" onclick="APP.statTab('cross')"><i class="fa-solid fa-table-cells"></i> äº¤å‰è¡¨</button>
            <button class="stat-tab" data-st="records" onclick="APP.statTab('records')"><i class="fa-solid fa-table"></i> ç´€éŒ„åˆ—è¡¨</button>
          </div>
          <!-- Tab content -->
          <div class="stat-content">
            <div class="stat-pane active" id="sp-overview">
              <div class="grid-4" id="stat-cards" style="margin-bottom:16px"></div>
              <div class="grid-2">
                <div class="chart-wrap"><h4><i class="fa-solid fa-chart-pie" style="color:var(--primary);margin-right:4px"></i>å‹æ…‹åˆ†å¸ƒ</h4><canvas id="ch-type"></canvas></div>
                <div class="chart-wrap"><h4><i class="fa-solid fa-chart-bar" style="color:var(--accent);margin-right:4px"></i>åˆ†æœŸåˆ†å¸ƒ</h4><canvas id="ch-stage"></canvas></div>
              </div>
            </div>
            <div class="stat-pane" id="sp-muttrend">
              <div class="grid-2">
                <div class="chart-wrap"><h4><i class="fa-solid fa-dna" style="color:var(--indigo);margin-right:4px"></i>çªè®Šåˆ†å¸ƒ</h4><canvas id="ch-mut"></canvas></div>
                <div class="chart-wrap"><h4><i class="fa-solid fa-calendar" style="color:var(--amber);margin-right:4px"></i>æœˆè¶¨å‹¢</h4><canvas id="ch-trend"></canvas></div>
              </div>
            </div>
            <div class="stat-pane" id="sp-checklist">
              <div class="grid-4" id="ck-stat-cards" style="margin-bottom:16px"></div>
              <div class="card"><div id="ck-stat-bars"></div></div>
            </div>
            <div class="stat-pane" id="sp-cross">
              <div class="card"><div style="overflow-x:auto" id="cross-table"></div></div>
            </div>
            <div class="stat-pane" id="sp-records">
              <div class="card"><div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border);text-align:left"><th style="padding:10px 8px;color:var(--text3)">æ”¶æ¡ˆæ—¥æœŸ</th><th style="padding:10px 8px;color:var(--text3)">ä»£è™Ÿ</th><th style="padding:10px 8px;color:var(--text3)">å§“å</th><th style="padding:10px 8px;color:var(--text3)">å‹æ…‹</th><th style="padding:10px 8px;color:var(--text3)">åˆ†æœŸ</th><th style="padding:10px 8px;color:var(--text3)">çªè®Š</th><th style="padding:10px 8px;color:var(--text3)">PD-L1</th><th style="padding:10px 8px;color:var(--text3)">æª¢æŸ¥</th><th style="padding:10px 8px;color:var(--text3)">æ“ä½œ</th></tr></thead><tbody id="stat-tbody"></tbody></table></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• PANEL: BACKUP â•â•â• -->
      <div class="panel" id="panel-backup"><div class="panel-inner">
        <h3 style="font-size:18px;font-weight:900;margin-bottom:20px"><i class="fa-solid fa-hard-drive" style="color:var(--primary);margin-right:8px"></i>è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
        <div class="bk-card">
          <h4 style="font-size:14px;font-weight:700;margin-bottom:14px;color:var(--text2)"><i class="fa-solid fa-download" style="color:var(--primary);margin-right:6px"></i>åŒ¯å‡º</h4>
          <button class="bk-btn" onclick="APP.backupAll()"><i class="fa-solid fa-database" style="color:var(--primary)"></i><div><div>å®Œæ•´å‚™ä»½</div><div class="bk-desc">åŒ¯å‡ºæ‰€æœ‰ç´€éŒ„ã€è‰ç¨¿ã€è¨­å®šï¼ˆ.jsonï¼‰</div></div></button>
          <button class="bk-btn" onclick="APP.exportCSV()"><i class="fa-solid fa-file-csv" style="color:var(--accent)"></i><div><div>CSV åŒ¯å‡º</div><div class="bk-desc">ç´”ç´€éŒ„è¡¨æ ¼ï¼Œå¯ç”¨ Excel é–‹å•Ÿ</div></div></button>
          <button class="bk-btn" onclick="APP.exportJSON()"><i class="fa-solid fa-file-code" style="color:var(--indigo)"></i><div><div>JSON åŒ¯å‡º</div><div class="bk-desc">ç´”ç´€éŒ„è³‡æ–™ï¼Œå¯ä¾›ç¨‹å¼è™•ç†</div></div></button>
        </div>
        <div class="bk-card">
          <h4 style="font-size:14px;font-weight:700;margin-bottom:14px;color:var(--text2)"><i class="fa-solid fa-upload" style="color:var(--amber);margin-right:6px"></i>åŒ¯å…¥</h4>
          <button class="bk-btn" onclick="document.getElementById('imp-backup').click()"><i class="fa-solid fa-shield-halved" style="color:var(--amber)"></i><div><div>é‚„åŸå®Œæ•´å‚™ä»½</div><div class="bk-desc">å¾å‚™ä»½æª”é‚„åŸï¼ˆä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™ï¼Œé‡è¤‡ ID è¦†è“‹ï¼‰</div></div></button>
          <button class="bk-btn" onclick="document.getElementById('imp-file').click()"><i class="fa-solid fa-file-import" style="color:var(--text2)"></i><div><div>åŒ¯å…¥ç´€éŒ„ JSON</div><div class="bk-desc">åŒ¯å…¥ç´”ç´€éŒ„ JSON æª”ï¼ˆæ¯ç­†åˆ†é…æ–° IDï¼‰</div></div></button>
        </div>
        <div class="bk-card" id="bk-status" style="background:var(--surface2)">
          <div style="display:flex;align-items:center;gap:12px">
            <i class="fa-solid fa-clock-rotate-left" style="font-size:20px;color:var(--text3)"></i>
            <div>
              <div style="font-size:13px;color:var(--text3)">ä¸Šæ¬¡å‚™ä»½</div>
              <div style="font-size:15px;font-weight:600" id="bk-last-time">å¾æœªå‚™ä»½</div>
            </div>
          </div>
        </div>
        <div class="alert-box warn" id="backup-warn" style="display:none;margin-top:16px"><i class="fa-solid fa-triangle-exclamation"></i><div>è¶…é 30 å¤©æœªå‚™ä»½ï¼å»ºè­°ç«‹å³é€²è¡Œã€Œå®Œæ•´å‚™ä»½ã€ã€‚</div></div>
      </div></div>

    </div><!-- content -->

    <div class="bottombar">
      <div class="step-dots" id="dots"></div>
      <div class="spacer"></div>
      <button class="btn-nav back" id="btn-back" onclick="APP.back()" disabled><i class="fa-solid fa-chevron-left"></i> ä¸Šä¸€æ­¥</button>
      <button class="btn-nav next" id="btn-next" onclick="APP.next()">ä¸‹ä¸€æ­¥ <i class="fa-solid fa-chevron-right"></i></button>
    </div>
  </div>
</div>
<input type="file" id="imp-file" accept=".json" style="display:none" onchange="APP.handleImport(event)">
<input type="file" id="imp-backup" accept=".json" style="display:none" onchange="APP.handleRestore(event)">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALL APP LOGIC â€” single global object
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var APP = {};
(function(A){

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  ğŸ‘‰ CONFIG â€” æ›ç™Œåˆ¥æ”¹é€™è£¡               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  id: 'lung',                          // ç™Œåˆ¥ä»£ç¢¼ï¼ˆå½±éŸ¿ DB nameï¼‰
  name: 'è‚ºç™Œè‡¨åºŠè·¯å¾‘',                  // é¡¯ç¤ºåç¨±
  org: 'å½°æ¿±ç§€å‚³ç™Œç—‡ä¸­å¿ƒ',               // æ©Ÿæ§‹å
  icon: 'fa-solid fa-lungs',            // FontAwesome icon
  dbName: 'LCNav',                      // IndexedDB nameï¼ˆæ¯ç™Œåˆ¥ä¸åŒï¼‰
  color: '#0d9b6a',                     // ä¸»é¡Œè‰²

  // ç—…ç†å‹æ…‹
  types: [
    {v:'AD', l:'è‚ºè…ºç™Œ', desc:'ä½”å°ç£æœ€å¤§å®—ï¼Œæ¨™é¶é¸æ“‡å¤š', icon:'fa-solid fa-lungs', color:'primary'},
    {v:'SCC', l:'é±—ç‹€ä¸Šçš®ç™Œ', desc:'å¤šèˆ‡å¸è¸ç›¸é—œ', icon:'fa-solid fa-shield-halved', color:'amber'},
    {v:'SCLC', l:'å°ç´°èƒè‚ºç™Œ', desc:'ç”Ÿé•·å¿«é€Ÿï¼ŒåŒ–æ”¾ç™‚æ•æ„Ÿ', icon:'fa-solid fa-bolt', color:'rose'},
  ],
  typeLabel: {AD:'è…ºç™Œ',SCC:'é±—ç™Œ',SCLC:'å°ç´°èƒ'},

  // åˆ†æœŸï¼ˆä¾å‹æ…‹ï¼‰
  stages: {
    AD:[{v:'I-II',l:'æ—©æœŸ I-II'},{v:'III',l:'å±€éƒ¨æ™šæœŸ III'},{v:'IV',l:'æ™šæœŸ IV'}],
    SCC:[{v:'I-II',l:'æ—©æœŸ I-II'},{v:'III',l:'å±€éƒ¨æ™šæœŸ III'},{v:'IV',l:'æ™šæœŸ IV'}],
    SCLC:[{v:'LS',l:'ä¾·é™æœŸ Limited'},{v:'ES',l:'æ“´æ•£æœŸ Extensive'}],
  },

  // æ±ºç­–æ¨¹é¡å¤–æ­¥é©Ÿï¼ˆçªè®Š & PD-L1ï¼‰â€” è‹¥ç™Œåˆ¥ä¸éœ€è¦å¯è¨­ç©º
  hasMutation: true,   // å…¨åŸŸé–‹é—œ
  hasPdl1: true,
  skipMutTypes: ['SCLC'],  // â˜… é€™äº›å‹æ…‹è·³éçªè®Š+PD-L1 æ­¥é©Ÿ

  // æŸ¥æª¢è¡¨
  checklist: [
    {id:'c1',g:'01 â€” æª¢æŸ¥åˆ†æœŸ',l:'å½±åƒ (CT/PET) å®Œæˆ'},
    {id:'c2',g:'01 â€” æª¢æŸ¥åˆ†æœŸ',l:'è…¦éƒ¨ MRI å®Œæˆ'},
    {id:'c3',g:'01 â€” æª¢æŸ¥åˆ†æœŸ',l:'åˆ‡ç‰‡ç—…ç†å ±å‘Šç¢ºèª'},
    {id:'c4',g:'02 â€” æ±ºç­–é—œéµ',l:'åŸºå› æª¢æ¸¬ (NGS) å·²é€'},
    {id:'c5',g:'02 â€” æ±ºç­–é—œéµ',l:'PD-L1 è¡¨ç¾åˆ†æ•¸ç¢ºèª'},
    {id:'c6',g:'02 â€” æ±ºç­–é—œéµ',l:'é‡å¤§å‚·ç—…å¡å·²ç”³è«‹'},
    {id:'c7',g:'03 â€” æº–å‚™é–‹æˆ°',l:'äººå·¥è¡€ç®¡ç½®å…¥ (Port-A)'},
    {id:'c8',g:'03 â€” æº–å‚™é–‹æˆ°',l:'ç‡Ÿé¤Šèˆ‡é«”åŠ›è©•ä¼°'},
    {id:'c9',g:'03 â€” æº–å‚™é–‹æˆ°',l:'ç§äººä¿éšªè«®è©¢å®Œæˆ'},
    {id:'c10',g:'04 â€” æå•ç´€éŒ„',l:'æ²»ç™‚é æœŸç›®æ¨™ç¢ºèª'},
    {id:'c11',g:'04 â€” æå•ç´€éŒ„',l:'ç·Šæ€¥è¯ç¹«çª—å£èˆ‡é›»è©±'},
    {id:'c12',g:'04 â€” æå•ç´€éŒ„',l:'å¸¸è¦‹å‰¯ä½œç”¨æ‡‰å°æ¸…å–®'},
  ],
};

// æ–¹ä¾¿å¼•ç”¨
const CK = CFG.checklist;
const TYPE_LABEL = CFG.typeLabel;
const STAGES = CFG.stages;

const PANELS = ['patient','checklist','decision','pathway','summary','records','stats','backup'];

let cur = 'patient';
let db;

// Session = current working patient
A.S = {code:'',name:'',caseDate:'',gender:'',birthday:'',ecog:'',type:'',stage:'',mutation:'',pdl1:'',notes:'',ck:{},created:new Date().toISOString()};
let editId = null;   // non-null = editing saved record
let draftId = null;  // non-null = editing draft

// â”€â”€ IndexedDB â”€â”€
function openDB(){
  return new Promise((ok,fail)=>{
    // delete & recreate if version conflict
    const r = indexedDB.open(CFG.dbName,1);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if(!d.objectStoreNames.contains('records')) d.createObjectStore('records',{keyPath:'id',autoIncrement:true});
      if(!d.objectStoreNames.contains('drafts')) d.createObjectStore('drafts',{keyPath:'id',autoIncrement:true});
      if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'key'});
    };
    r.onsuccess = e => { db=e.target.result; ok(); };
    r.onerror = e => fail(e);
  });
}
function put(s,d){ return new Promise(r=>{ const t=db.transaction(s,'readwrite'); t.objectStore(s).put(d); t.oncomplete=()=>r(); }); }
function get(s,k){ return new Promise(r=>{ const t=db.transaction(s); const q=t.objectStore(s).get(k); q.onsuccess=()=>r(q.result); }); }
function getAll(s){ return new Promise(r=>{ const t=db.transaction(s); const q=t.objectStore(s).getAll(); q.onsuccess=()=>r(q.result); }); }
function del(s,k){ return new Promise(r=>{ const t=db.transaction(s,'readwrite'); t.objectStore(s).delete(k); t.oncomplete=()=>r(); }); }

// â”€â”€ Navigation â”€â”€
A.go = function(name){
  try{
    readForm();
    saveDraft();
    // Also auto-save checklist to record if editing a saved record
    if(editId && (cur==='checklist'||cur==='decision'||cur==='pathway')){
      autoUpdateRecord();
    }
  } catch(e){}
  cur = name;
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id==='panel-'+name));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active', n.dataset.panel===name));
  updateBar();
  if(name==='records') loadList();
  if(name==='pathway'){ renderPW(); }
  if(name==='summary'){ document.getElementById('sum-saved').style.display='none'; renderSummary(); }
  if(name==='checklist') renderCK();
  if(name==='stats') loadStats();
  if(name==='backup') loadBackupStatus();
};

async function autoUpdateRecord(){
  if(!editId) return;
  try{
    const existing = await get('records', editId);
    if(!existing) return;
    existing.ck = A.S.ck;
    existing.notes = A.S.notes;
    existing.code = A.S.code;
    existing.name = A.S.name;
    existing.caseDate = A.S.caseDate;
    existing.gender = A.S.gender;
    existing.birthday = A.S.birthday;
    existing.ecog = A.S.ecog;
    await put('records', existing);
  }catch(e){}
}
A.back = function(){ const flow=['patient','checklist','decision','pathway','summary']; const i=flow.indexOf(cur); if(i>0) A.go(flow[i-1]); };
A.next = function(){ const flow=['patient','checklist','decision','pathway','summary']; const i=flow.indexOf(cur); readForm(); if(i>=0&&i<flow.length-1) A.go(flow[i+1]); };

function updateBar(){
  const flowPanels = ['patient','checklist','decision','pathway','summary'];
  const i = flowPanels.indexOf(cur);
  const isFlow = i >= 0;
  document.getElementById('btn-back').disabled = (i<=0);
  document.getElementById('btn-back').style.display = isFlow && i>0 ? '' : 'none';
  const btnN = document.getElementById('btn-next');
  if(isFlow && cur!=='summary'){ btnN.style.display=''; btnN.innerHTML='ä¸‹ä¸€æ­¥ <i class="fa-solid fa-chevron-right"></i>'; }
  else { btnN.style.display='none'; }
  document.getElementById('dots').innerHTML = flowPanels.map((_,j)=>`<div class="step-dot${j===i?' active':''}"></div>`).join('');
}

function todayStr(){ const d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }

function readForm(){
  A.S.code = document.getElementById('pt-code').value.trim();
  A.S.name = document.getElementById('pt-name').value.trim();
  A.S.caseDate = document.getElementById('pt-casedate').value || todayStr();
  A.S.birthday = document.getElementById('pt-birthday').value;
  A.S.notes = document.getElementById('pt-notes').value;
}

// â”€â”€ Age calculation â”€â”€
function calcAgeFromDates(birthday, refDate){
  if(!birthday) return null;
  const b = new Date(birthday), r = new Date(refDate || todayStr());
  let age = r.getFullYear() - b.getFullYear();
  const m = r.getMonth() - b.getMonth();
  if(m < 0 || (m === 0 && r.getDate() < b.getDate())) age--;
  return age >= 0 ? age : null;
}
A.calcAge = function(){
  A.S.birthday = document.getElementById('pt-birthday').value;
  const ref = document.getElementById('pt-casedate').value || todayStr();
  const age = calcAgeFromDates(A.S.birthday, ref);
  document.getElementById('pt-age-display').textContent = age !== null ? `â†’ ${age} æ­²` : '';
};

// â”€â”€ Patient form helpers â”€â”€
A.pickGender = function(v){ A.S.gender=v; document.querySelectorAll('.gender-btn').forEach(b=>b.classList.toggle('selected',b.dataset.val===v)); };
A.pickECOG = function(v){ A.S.ecog=v; document.querySelectorAll('.ecog-btn').forEach(b=>b.classList.toggle('selected',b.dataset.val===v)); };

// â”€â”€ Draft auto-save â”€â”€
async function saveDraft(){
  if(!A.S.code && !A.S.type) return;
  if(editId) return; // don't auto-draft when editing saved record
  const d = {...A.S, updatedAt: new Date().toISOString()};
  if(draftId) d.id = draftId;
  else delete d.id;
  await put('drafts', d);
  if(!draftId){ const all = await getAll('drafts'); draftId = all[all.length-1]?.id; }
}

// â”€â”€ Record list (records panel) â”€â”€
let allRecordItems = []; // cache for filtering

A.filterRecords = function(){ renderRecordList(); };

async function loadList(){
  const drafts = await getAll('drafts');
  const records = await getAll('records');
  allRecordItems = [];
  drafts.forEach(d=>allRecordItems.push({...d,_k:'draft',_d:d.updatedAt||d.created}));
  records.forEach(r=>allRecordItems.push({...r,_k:'saved',_d:r.caseDate||r.savedAt||r.created}));
  allRecordItems.sort((a,b)=>new Date(b._d)-new Date(a._d));
  renderRecordList();
}

function renderRecordList(){
  const q = (document.getElementById('rec-search')?.value||'').trim().toLowerCase();
  const sf = document.getElementById('rec-status')?.value||'all';
  const tf = document.getElementById('rec-type')?.value||'';
  const stf = document.getElementById('rec-stage')?.value||'';
  let items = allRecordItems;
  if(sf!=='all') items = items.filter(d=>d._k===sf);
  if(tf) items = items.filter(d=>d.type===tf);
  if(stf) items = items.filter(d=>d.stage===stf);
  if(q) items = items.filter(d=>{
    const haystack = [d.code||'',d.name||'',d.notes||'',TYPE_LABEL[d.type]||'',d.stage||''].join(' ').toLowerCase();
    return haystack.includes(q);
  });
  const el = document.getElementById('record-list');
  const countEl = document.getElementById('rec-count');
  if(countEl) countEl.textContent = `${items.length} / ${allRecordItems.length} ç­†`;
  if(!items.length){ el.innerHTML='<div style="padding:40px;text-align:center;color:var(--text3);font-size:14px"><i class="fa-solid fa-inbox" style="font-size:28px;display:block;margin-bottom:10px;opacity:.4"></i>'+(q?'æ‰¾ä¸åˆ°ç¬¦åˆçš„ç´€éŒ„':'å°šç„¡ç´€éŒ„')+'</div>'; return; }
  el.innerHTML = items.map(d=>{
    const dt = new Date(d._d);
    const ds = dt.toLocaleDateString('zh-TW')+' '+dt.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});
    const saved = d._k==='saved';
    const badge = saved ? '<span class="badge nhi" style="font-size:10px">å·²å­˜æª”</span>' : '<span class="badge warn" style="font-size:10px">è‰ç¨¿</span>';
    const typeStr = d.type?TYPE_LABEL[d.type]:'';
    const info = [typeStr,d.stage||''].filter(Boolean).join(' Â· ')||'å°šæœªå¡«å¯«';
    const ckDone = d.ck ? Object.keys(d.ck).length : 0;
    const ckInfo = ckDone > 0 ? ` Â· <span style="font-family:'JetBrains Mono',monospace">${ckDone}/${CK.length}</span>` : '';
    let codeTxt = d.code||'ï¼ˆæœªå‘½åï¼‰';
    const nameTxt = d.name ? ` <span style="font-weight:400;color:var(--text2)">${d.name}</span>` : '';
    if(q && d.code){ codeTxt = highlightMatch(codeTxt, q); }
    return `<div class="rec-row" onclick="APP.load(${d.id},'${d._k}')">
      <div class="rec-info"><div class="rec-title">${codeTxt}${nameTxt} ${badge}</div><div class="rec-meta">${info}${ckInfo}</div></div>
      <div class="rec-date">${ds}</div>
      <button class="rec-del" onclick="event.stopPropagation();APP.del(${d.id},'${d._k}')" title="åˆªé™¤"><i class="fa-solid fa-trash-can"></i></button>
    </div>`;
  }).join('');
}

function highlightMatch(text, q){
  const idx = text.toLowerCase().indexOf(q);
  if(idx<0) return text;
  return text.substring(0,idx)+'<mark>'+text.substring(idx,idx+q.length)+'</mark>'+text.substring(idx+q.length);
}

A.load = async function(id, kind){
  const obj = kind==='saved' ? await get('records',id) : await get('drafts',id);
  if(!obj) return;
  A.S = {...obj};
  editId = kind==='saved' ? id : null;
  draftId = kind==='draft' ? id : null;
  // fill form
  document.getElementById('pt-code').value = A.S.code||'';
  document.getElementById('pt-name').value = A.S.name||'';
  document.getElementById('pt-casedate').value = A.S.caseDate||'';
  document.getElementById('pt-birthday').value = A.S.birthday||'';
  document.getElementById('pt-notes').value = A.S.notes||'';
  document.querySelectorAll('.gender-btn').forEach(b=>b.classList.toggle('selected',b.dataset.val===A.S.gender));
  document.querySelectorAll('.ecog-btn').forEach(b=>b.classList.toggle('selected',b.dataset.val===A.S.ecog));
  A.calcAge();
  restoreDT();
  renderCK();
  updateTitle();
  // always start from patient page when loading
  A.go('patient');
};

A.del = async function(id, kind){
  if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  await del(kind==='saved'?'records':'drafts', id);
  if(editId===id) editId=null;
  if(draftId===id) draftId=null;
  loadList();
};

function updateTitle(){
  const t = document.getElementById('topbar-title');
  const label = A.S.code ? (A.S.name ? A.S.code+' '+A.S.name : A.S.code) : CFG.name;
  const tag = editId ? '<span style="font-size:12px;color:var(--amber);margin-left:6px">ï¼ˆç·¨è¼¯ä¸­ï¼‰</span>' : draftId ? '<span style="font-size:12px;color:var(--text3);margin-left:6px">ï¼ˆè‰ç¨¿ï¼‰</span>' : '';
  t.innerHTML = `<i class="${CFG.icon}"></i> ${label}${tag}`;
}

A.newPatient = function(){
  if(!confirm('é–‹å§‹æ–°ç—…äººï¼Ÿ')) return;
  editId=null; draftId=null;
  A.S={code:'',name:'',caseDate:todayStr(),gender:'',birthday:'',ecog:'',type:'',stage:'',mutation:'',pdl1:'',notes:'',ck:{},created:new Date().toISOString()};
  document.getElementById('pt-code').value='';
  document.getElementById('pt-name').value='';
  document.getElementById('pt-casedate').value=todayStr();
  document.getElementById('pt-birthday').value='';
  document.getElementById('pt-age-display').textContent='';
  document.getElementById('pt-notes').value='';
  document.querySelectorAll('.gender-btn,.ecog-btn,.dt-btn').forEach(b=>b.classList.remove('selected'));
  dtShowCard(1);
  updateTitle();
  renderCK();
  A.go('patient');
};

// â”€â”€ Decision Tree (card-based navigation) â”€â”€
let dtStep = 1; // current card step

function dtShowCard(n){
  dtStep = n;
  document.querySelectorAll('.dt-card').forEach(c=>c.classList.remove('active'));
  const card = document.getElementById(n==='done'?'dt-card-done':'dt-card-'+n);
  if(card) card.classList.add('active');
  updateDtSteps();
}

// â˜… Helper: does this type need mutation/pdl1 steps?
function needsMut(t){ return CFG.hasMutation && !(CFG.skipMutTypes||[]).includes(t); }
function needsPdl1(t){ return CFG.hasPdl1 && !(CFG.skipMutTypes||[]).includes(t); }
function totalStepsFor(t){ return 2 + (needsMut(t)?1:0) + (needsPdl1(t)?1:0); }

function updateDtSteps(){
  const t = A.S.type;
  const total = t ? totalStepsFor(t) : 4;
  const dots = document.querySelectorAll('.dt-dot');
  const lines = document.querySelectorAll('.dt-line');
  dots.forEach((d,i)=>{
    const s = i+1;
    d.style.display = s<=total?'flex':'none';
    d.classList.remove('active','done');
    if(dtStep==='done'||s<dtStep) d.classList.add('done');
    else if(s==dtStep) d.classList.add('active');
  });
  lines.forEach((l,i)=>{
    l.style.display = (i+1)<total?'block':'none';
    l.classList.toggle('done', dtStep==='done'||(i+1)<dtStep);
  });
}

A.dt = function(q,v){
  A.S[q]=v;
  document.querySelectorAll(`.dt-btn[data-q="${q}"]`).forEach(b=>b.classList.toggle('selected',b.dataset.val===v));
  // Auto-advance after brief delay for visual feedback
  setTimeout(()=>{
    if(q==='type'){ showStage(v); }
    else if(q==='stage'){ showMut(); }
    else if(q==='mutation'){ showPDL1(); }
    else if(q==='pdl1'){ showDone(); }
  },150);
};

function showStage(type){
  const opts=document.getElementById('q-stage-opts');
  document.getElementById('q-stage-label').textContent = 'è‡¨åºŠåˆ†æœŸ';
  opts.innerHTML = STAGES[type].map(s=>`<button class="big-btn dt-btn" data-q="stage" data-val="${s.v}" onclick="APP.dt('stage','${s.v}')"><div><div class="btn-label">${s.l}</div></div></button>`).join('');
  A.S.stage='';A.S.mutation='';A.S.pdl1='';
  dtShowCard(2);
}
function showMut(){
  if(!needsMut(A.S.type)){ A.S.mutation='N/A'; if(!needsPdl1(A.S.type)){A.S.pdl1='N/A';showDone();}else{showPDL1();} return; }
  A.S.mutation='';A.S.pdl1='';
  document.querySelectorAll('.dt-btn[data-q="mutation"]').forEach(b=>b.classList.remove('selected'));
  dtShowCard(3);
}
function showPDL1(){
  if(!needsPdl1(A.S.type)){ A.S.pdl1='N/A'; showDone(); return; }
  A.S.pdl1='';
  document.querySelectorAll('.dt-btn[data-q="pdl1"]').forEach(b=>b.classList.remove('selected'));
  dtShowCard(4);
}
function showDone(){
  const t=TYPE_LABEL[A.S.type]||'';
  const parts=[t,A.S.stage];
  if(A.S.mutation&&A.S.mutation!=='N/A') parts.push('çªè®Š:'+A.S.mutation);
  if(A.S.pdl1&&A.S.pdl1!=='N/A') parts.push('PD-L1:'+A.S.pdl1);
  document.getElementById('dt-summary-text').textContent=parts.join(' Â· ');
  dtShowCard('done');
}

A.dtBack = function(to){
  if(to==='last'){
    to = totalStepsFor(A.S.type);
  }
  dtShowCard(to);
};

function restoreDT(){
  document.querySelectorAll('.dt-btn').forEach(b=>b.classList.remove('selected'));
  if(!A.S.type){ dtShowCard(1); return; }
  const savedType=A.S.type, savedStage=A.S.stage, savedMut=A.S.mutation, savedPdl1=A.S.pdl1;
  // Highlight type
  document.querySelectorAll('.dt-btn[data-q="type"]').forEach(b=>b.classList.toggle('selected',b.dataset.val===savedType));
  // Build stage opts (without wiping values)
  const opts=document.getElementById('q-stage-opts');
  document.getElementById('q-stage-label').textContent = 'è‡¨åºŠåˆ†æœŸ';
  opts.innerHTML = STAGES[savedType].map(s=>`<button class="big-btn dt-btn" data-q="stage" data-val="${s.v}" onclick="APP.dt('stage','${s.v}')"><div><div class="btn-label">${s.l}</div></div></button>`).join('');
  // Restore values
  A.S.type=savedType; A.S.stage=savedStage; A.S.mutation=savedMut; A.S.pdl1=savedPdl1;
  if(!savedStage){ dtShowCard(2); return; }
  document.querySelectorAll('.dt-btn[data-q="stage"]').forEach(b=>b.classList.toggle('selected',b.dataset.val===savedStage));
  if(!needsMut(savedType)){
    // Skip mutation/pdl1 â†’ done
    const parts=[TYPE_LABEL[savedType],savedStage];
    if(needsPdl1(savedType)&&savedPdl1&&savedPdl1!=='N/A') parts.push('PD-L1:'+savedPdl1);
    document.getElementById('dt-summary-text').textContent=parts.join(' Â· ');
    if(needsPdl1(savedType)&&!savedPdl1){ dtShowCard(4); return; }
    if(needsPdl1(savedType)) document.querySelectorAll('.dt-btn[data-q="pdl1"]').forEach(b=>b.classList.toggle('selected',b.dataset.val===savedPdl1));
    dtShowCard('done');
    return;
  }
  if(!savedMut){ dtShowCard(3); return; }
  document.querySelectorAll('.dt-btn[data-q="mutation"]').forEach(b=>b.classList.toggle('selected',b.dataset.val===savedMut));
  if(needsPdl1(savedType)){
    if(!savedPdl1){ dtShowCard(4); return; }
    document.querySelectorAll('.dt-btn[data-q="pdl1"]').forEach(b=>b.classList.toggle('selected',b.dataset.val===savedPdl1));
  }
  // All done
  const parts=[TYPE_LABEL[savedType],savedStage];
  if(savedMut&&savedMut!=='N/A') parts.push('çªè®Š:'+savedMut);
  if(savedPdl1&&savedPdl1!=='N/A') parts.push('PD-L1:'+savedPdl1);
  document.getElementById('dt-summary-text').textContent=parts.join(' Â· ');
  dtShowCard('done');
}

// â”€â”€ Pathway â”€â”€
function renderPW(){
  if(!A.S.type||!A.S.stage){ document.getElementById('pw-empty').style.display=''; document.getElementById('pw-wrap').style.display='none'; return; }
  document.getElementById('pw-empty').style.display='none';
  document.getElementById('pw-wrap').style.display='flex';
  const S=A.S;
  // Left sidebar
  let side = '<div class="pw-side-title"><i class="fa-solid fa-microscope" style="margin-right:4px"></i> æ±ºç­–çµæœ</div>';
  side += `<div class="pw-side-row"><span class="l">å‹æ…‹</span><span class="v">${TYPE_LABEL[S.type]}</span></div>`;
  side += `<div class="pw-side-row"><span class="l">åˆ†æœŸ</span><span class="v">${S.stage}</span></div>`;
  if(needsMut(S.type)){
    if(S.mutation&&S.mutation!=='N/A') side += `<div class="pw-side-row"><span class="l">çªè®Š</span><span class="v">${S.mutation}</span></div>`;
  }
  if(needsPdl1(S.type)){
    if(S.pdl1&&S.pdl1!=='N/A') side += `<div class="pw-side-row"><span class="l">PD-L1</span><span class="v">${S.pdl1}</span></div>`;
  }
  side += `<div style="flex:1"></div>`;
  side += `<button class="btn-nav next" onclick="APP.go('summary')" style="padding:0 16px;width:100%;justify-content:center"><i class="fa-solid fa-id-card-clip"></i> ç¸½è¦½</button>`;
  document.getElementById('pw-side').innerHTML = side;
  // Middle: treatment + Right: cost
  const fn = PW[S.type]?.[S.stage];
  if(fn){
    const result = fn(S);
    document.getElementById('pw-content').innerHTML = `<div class="card">${result.tx}</div>`;
    let costH = '<div class="pw-cost-title"><i class="fa-solid fa-coins" style="color:var(--amber)"></i> ğŸ’° è²»ç”¨æ¦‚ä¼°</div>';
    (result.cost||[]).forEach(c=>{ costH += `<div class="pw-cost-row"><span class="l">${c.l}</span><span class="v">${c.v}</span></div>`; });
    document.getElementById('pw-cost').innerHTML = costH;
  } else {
    document.getElementById('pw-content').innerHTML = '<div class="card"><p>æ­¤çµ„åˆå°šç„¡è·¯å¾‘è³‡æ–™ï¼Œè«‹èˆ‡ä¸»æ²»é†«å¸«ç¢ºèªã€‚</p></div>';
    document.getElementById('pw-cost').innerHTML = '';
  }
}

// Pathway templates
const PW = {
  AD:{
    'I-II': s => ({
      tx:`<div class="card-title"><i class="fa-solid fa-hand-holding-medical"></i> æ—©æœŸè…ºç™Œ (I-II)</div>
        <div class="tx-box green"><h4>ğŸ”¹ æ‰‹è¡“åˆ‡é™¤</h4><p>å¥ä¿çµ¦ä»˜ VATS å¾®å‰µæ‰‹è¡“ã€‚</p></div>
        <div class="tx-box gray"><h4>ğŸ”¹ è¡“å¾Œéå›º</h4><div class="row"><span>è¼”åŠ©åŒ–ç™‚ Ã—4</span><span class="badge nhi">å¥ä¿</span></div>${s.mutation==='EGFR'?'<div class="row"><span>Osimertinib 3å¹´</span><span class="badge self">è‡ªè²»/æ¢ä»¶ç”³è«‹</span></div><p class="note">ADAURA è©¦é©—ï¼šEGFR+ è¡“å¾Œå£æœå¯å¤§å¹…é™ä½å¾©ç™¼ã€‚</p>':''}</div>
        <div class="tx-box amber"><h4>âš¡ ä¸èƒ½æ‰‹è¡“ â†’ SBRT</h4><p>3-5æ¬¡ç…§å°„ï¼Œå±€éƒ¨æ§åˆ¶ç‡è¿‘ä¼¼æ‰‹è¡“ã€‚</p><div class="row"><span></span><span class="badge nhi">å¥ä¿</span></div></div>`,
      cost:[{l:'VATS æ‰‹è¡“',v:'å¥ä¿å…¨é¡'},{l:'é”æ–‡è¥¿å·®é¡',v:'15-25è¬'}].concat(s.mutation==='EGFR'?[{l:'Osimertinib è‡ªè²»/æœˆ',v:'10-15è¬'}]:[])
    }),
    'III': () => ({
      tx:`<div class="card-title"><i class="fa-solid fa-code-branch"></i> å±€éƒ¨æ™šæœŸè…ºç™Œ (III)</div>
        <div class="grid-2"><div class="tx-box green" style="border:2px solid #a7f3d0"><h4>è·¯å¾‘Aï¼šå¯æ‰‹è¡“</h4><div class="tx-box dark" style="margin-top:8px"><b>è¡“å‰åŒ–ç™‚Â±å…ç–« â†’ æ‰‹è¡“ â†’ éå›º</b><p class="note">Nivolumab neoadjuvant ç›®å‰éœ€è‡ªè²»ã€‚</p></div></div>
        <div class="tx-box amber" style="border:2px solid var(--amber-border)"><h4>è·¯å¾‘Bï¼šä¸å¯æ‰‹è¡“</h4><div class="tx-box dark" style="margin-top:8px"><b style="color:#fbbf24">CCRT â†’ Durvalumab 1å¹´</b><p class="note">PACIFIC è©¦é©—äº”å¹´å­˜æ´»é¡¯è‘—æå‡ã€‚å·²ç´å¥ä¿ã€‚</p></div></div></div>`,
      cost:[{l:'CCRT',v:'å¥ä¿å…¨é¡'},{l:'Durvalumab',v:'å¥ä¿ç”³è«‹'},{l:'Nivolumab è‡ªè²»',v:'æ¯æ¬¡ 8-12è¬'}]
    }),
    'IV': s=>{
      let tx='';
      if(s.mutation==='EGFR'||s.mutation==='ALK'||s.mutation==='OTHER'){
        tx=`<div class="tx-box green"><h4>ğŸ¯ æ¨™é¶æ²»ç™‚</h4>${s.mutation==='EGFR'?'<p>EGFR â€” Osimertinib ä¸€ç·šå¥ä¿çµ¦ä»˜ã€‚</p>':s.mutation==='ALK'?'<p>ALK â€” Alectinib / Lorlatinib ä¸€ç·šå¥ä¿ã€‚</p>':'<p>ROS1/BRAF/MET/RET/KRAS G12C ç­‰çš†æœ‰å°æ‡‰è—¥ç‰©ã€‚</p>'}<div class="row"><span></span><span class="badge nhi">å¥ä¿ç‚ºä¸»</span></div></div>`;
      } else if(s.mutation==='PENDING'){
        tx=`<div class="alert-box warn"><i class="fa-solid fa-clock"></i><div><b>ç­‰å ±å‘Šä¸­</b> â€” æ€¥æ™‚å¯å…ˆåŒ–ç™‚èµ·æ­¥ï¼Œå ±å‘Šå‡ºçˆå†èª¿æ•´ã€‚</div></div>`;
      } else {
        tx=`<div class="tx-box blue"><h4>ğŸ›¡ï¸ å…ç–« Â± åŒ–ç™‚</h4>${s.pdl1==='>=50'?'<p>PD-L1 â‰¥50%ï¼šPembrolizumab å–®è—¥ï¼Œå¥ä¿å¯ç”³è«‹ã€‚</p>':s.pdl1==='1-49'?'<p>PD-L1 1-49%ï¼šå…ç–«+åŒ–ç™‚ (Pembrolizumab+Pemetrexed+Platinum)ã€‚</p>':s.pdl1==='<1'?'<p>PD-L1 <1%ï¼šåŒ–ç™‚åˆä½µå…ç–«ç‚ºä¸»ã€‚</p>':'<p>å»ºè­°è£œæ¸¬ PD-L1ï¼Œæš«ä»¥åŒ–ç™‚èµ·æ­¥ã€‚</p>'}<div class="row"><span></span><span class="badge nhi">æ¢ä»¶ç”³è«‹</span></div></div>`;
      }
      return {
        tx:`<div class="card-title"><i class="fa-solid fa-bullseye"></i> æ™šæœŸè…ºç™Œ (IV)</div>${tx}`,
        cost:[{l:'åŒ–ç™‚',v:'å¥ä¿å…¨é¡'},{l:'Pembrolizumab (â‰¥50%)',v:'å¥ä¿ç”³è«‹'},{l:'å…ç–«è‡ªè²»/æœˆ',v:'15-20è¬'},{l:'æ¨™é¶(æœ‰å¥ä¿)',v:'å¥ä¿å…¨é¡'}]
      };
    }
  },
  SCC:{
    'I-II':()=>({
      tx:`<div class="card-title"><i class="fa-solid fa-hand-holding-medical"></i> é±—ç™Œæ—©æœŸ (I-II)</div><div class="tx-box green"><h4>æ‰‹è¡“åˆ‡é™¤</h4><p>è‚ºè‘‰åˆ‡é™¤+æ·‹å·´çµå»“æ¸…ã€‚</p></div><div class="tx-box gray"><h4>è¡“å¾ŒåŒ–ç™‚ Ã—4</h4><p>é‰‘é¡åŒ–ç™‚ã€‚</p><div class="row"><span></span><span class="badge nhi">å¥ä¿</span></div></div><div class="tx-box amber"><h4>âš¡ ä¸èƒ½æ‰‹è¡“ â†’ SBRT</h4><div class="row"><span></span><span class="badge nhi">å¥ä¿</span></div></div>`,
      cost:[{l:'æ‰‹è¡“',v:'å¥ä¿å…¨é¡'},{l:'åŒ–ç™‚',v:'å¥ä¿å…¨é¡'},{l:'SBRT',v:'å¥ä¿å…¨é¡'}]
    }),
    'III':()=>({
      tx:`<div class="card-title"><i class="fa-solid fa-radiation"></i> é±—ç™Œ III æœŸ</div><div class="tx-box amber"><h4>CCRT</h4><p>åŒ–ç™‚+æ”¾ç™‚ 6-7é€±ã€‚</p></div><div class="tx-box dark"><h4>PACIFICï¼šDurvalumab 1å¹´</h4><p>å·²ç´å¥ä¿(éœ€ç”³è«‹)ã€‚</p></div>`,
      cost:[{l:'CCRT',v:'å¥ä¿å…¨é¡'},{l:'Durvalumab',v:'å¥ä¿ç”³è«‹'}]
    }),
    'IV':s=>({
      tx:`<div class="card-title"><i class="fa-solid fa-shield-halved"></i> é±—ç™Œ IV æœŸ</div><div class="tx-box blue"><h4>ğŸ›¡ï¸ å…ç–«Â±åŒ–ç™‚</h4>${s.pdl1==='>=50'?'<p>Pembrolizumab å–®è—¥ï¼Œå¥ä¿å¯ç”³è«‹ã€‚</p>':'<p>Pembrolizumab + Carboplatin + nab-Paclitaxelã€‚</p>'}</div><div class="tx-box gray"><h4>åŒ–ç™‚æ–¹æ¡ˆ</h4><p>Gemcitabine + Cisplatin å¥ä¿å…¨é¡ã€‚</p></div>`,
      cost:[{l:'åŒ–ç™‚',v:'å¥ä¿å…¨é¡'},{l:'Pembrolizumab',v:'å¥ä¿ç”³è«‹'},{l:'å…ç–«è‡ªè²»/æœˆ',v:'15-20è¬'}]
    })
  },
  SCLC:{
    'LS':()=>({
      tx:`<div class="card-title" style="color:var(--rose)"><i class="fa-solid fa-bolt"></i> å°ç´°èƒ ä¾·é™æœŸ</div><div class="tx-box rose"><h4>CCRT</h4><p>EP åŒ–ç™‚ Ã—4 + èƒ¸éƒ¨æ”¾ç™‚ã€‚</p><div class="row"><span></span><span class="badge nhi">å¥ä¿</span></div></div><div class="tx-box dark"><h4>é é˜²æ€§å…¨è…¦ç…§å°„ (PCI)</h4><p style="font-style:italic">å³ä½¿ MRI æœªè¦‹è½‰ç§»ä»å»ºè­°æ–½ä½œã€‚å¥ä¿çµ¦ä»˜ã€‚</p></div>`,
      cost:[{l:'EP + æ”¾ç™‚',v:'å¥ä¿å…¨é¡'},{l:'PCI',v:'å¥ä¿å…¨é¡'}]
    }),
    'ES':()=>({
      tx:`<div class="card-title"><i class="fa-solid fa-bolt"></i> å°ç´°èƒ æ“´æ•£æœŸ</div><div class="tx-box blue"><h4>â­ åŒ–ç™‚+å…ç–« (åœ‹éš›é¦–é¸)</h4><p>Atezolizumab/Durvalumab + EPã€‚</p><div class="row"><span></span><span class="badge self">å…ç–«è‡ªè²»</span></div></div><div class="tx-box gray"><h4>åŒ–ç™‚</h4><p>EP Ã—4-6ï¼Œå¥ä¿å…¨é¡ã€‚</p></div><div class="tx-box dark"><h4>è…¦è½‰ç§»</h4><p>WBRT / PCIã€‚</p></div>`,
      cost:[{l:'EP åŒ–ç™‚',v:'å¥ä¿å…¨é¡'},{l:'Atezolizumab è‡ªè²»/æ¬¡',v:'10-15è¬'},{l:'WBRT',v:'å¥ä¿å…¨é¡'}]
    })
  }
};

// â”€â”€ Save record â”€â”€
A.save = async function(){
  if(!A.S.type||!A.S.stage){ alert('è«‹å…ˆå®Œæˆæ±ºç­–å•ç­”'); return; }
  readForm();
  const now = new Date().toISOString();
  const rec = {code:A.S.code,name:A.S.name,caseDate:A.S.caseDate,gender:A.S.gender,birthday:A.S.birthday,ecog:A.S.ecog,type:A.S.type,stage:A.S.stage,mutation:A.S.mutation,pdl1:A.S.pdl1,notes:A.S.notes,ck:A.S.ck,created:A.S.created,savedAt:now};
  let isNew = !editId;
  if(editId){
    rec.id = editId;
    await put('records', rec);
  } else {
    await put('records', rec);
    if(draftId){ await del('drafts',draftId); draftId=null; }
    const all = await getAll('records');
    editId = all[all.length-1]?.id;
  }
  await put('settings',{key:'lastSave',value:now});
  updateTitle();
  // Show post-save in summary panel
  document.getElementById('sum-content').style.display='none';
  document.getElementById('sum-empty').style.display='none';
  document.getElementById('sum-saved').style.display='';
  document.getElementById('sum-saved-info').textContent = `${A.S.code||'ç—…äºº'} Â· ${TYPE_LABEL[A.S.type]||''} Â· ${A.S.stage} â€” ${isNew?'å·²æ–°å¢':'å·²æ›´æ–°'}`;
};

A.continueSummary = function(){
  document.getElementById('sum-saved').style.display='none';
  document.getElementById('sum-content').style.display='';
};
A.printSummary = function(){
  window.print();
};

// â”€â”€ Summary panel â”€â”€
const PW_SUMMARY = {
  AD:{
    'I-II': s => s.mutation==='EGFR' ? 'æ‰‹è¡“åˆ‡é™¤ + Osimertinib è¼”åŠ©ï¼ˆADAURAï¼‰' : 'æ‰‹è¡“åˆ‡é™¤ Â± è¼”åŠ©åŒ–ç™‚',
    'III': () => 'è·¯å¾‘A å¯æ‰‹è¡“ï¼šè¡“å‰åŒ–ç™‚Â±å…ç–« â†’ æ‰‹è¡“ / è·¯å¾‘B ä¸å¯æ‰‹è¡“ï¼šCCRT â†’ Durvalumab',
    'IV': s => {
      if(s.mutation==='EGFR') return 'EGFR æ¨™é¶ï¼šOsimertinib ä¸€ç·šï¼ˆå¥ä¿ï¼‰';
      if(s.mutation==='ALK') return 'ALK æ¨™é¶ï¼šAlectinib / Lorlatinibï¼ˆå¥ä¿ï¼‰';
      if(s.mutation==='OTHER') return 'å°æ‡‰æ¨™é¶æ²»ç™‚ï¼ˆROS1/BRAF/MET/RET/KRASï¼‰';
      if(s.mutation==='PENDING') return 'ç­‰å ±å‘Šä¸­ â€” å¯å…ˆåŒ–ç™‚èµ·æ­¥';
      if(s.pdl1==='>=50') return 'Pembrolizumab å–®è—¥ï¼ˆå¥ä¿å¯ç”³è«‹ï¼‰';
      return 'å…ç–« + åŒ–ç™‚åˆä½µ';
    }
  },
  SCC:{
    'I-II': () => 'æ‰‹è¡“åˆ‡é™¤ + è¡“å¾ŒåŒ–ç™‚ / ä¸èƒ½æ‰‹è¡“ â†’ SBRT',
    'III': () => 'CCRT â†’ Durvalumab 1å¹´ï¼ˆPACIFICï¼Œå¥ä¿ï¼‰',
    'IV': s => s.pdl1==='>=50' ? 'Pembrolizumab å–®è—¥ï¼ˆå¥ä¿ç”³è«‹ï¼‰' : 'Pembrolizumab + Carboplatin + nab-Paclitaxel'
  },
  SCLC:{
    'LS': () => 'CCRT (EPÃ—4 + èƒ¸éƒ¨æ”¾ç™‚) â†’ PCI',
    'ES': () => 'åŒ–ç™‚ (EP) + å…ç–« (Atezolizumab/Durvalumab)'
  }
};

function renderSummary(){
  const S = A.S;
  if(!S.code && !S.type){ document.getElementById('sum-empty').style.display=''; document.getElementById('sum-content').style.display='none'; return; }
  document.getElementById('sum-empty').style.display='none';
  document.getElementById('sum-content').style.display='';
  document.getElementById('sum-save-label').textContent = editId ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„';

  // Patient row
  const age = calcAgeFromDates(S.birthday, S.caseDate||todayStr());
  const cells = [
    {l:'ä»£è™Ÿ',v:S.code||'â€”'},{l:'å§“å',v:S.name||'â€”'},
    {l:'æ€§åˆ¥',v:S.gender==='M'?'ç”·':S.gender==='F'?'å¥³':'â€”'},
    {l:'å¹´é½¡',v:age!==null?age+'æ­²':'â€”'},
    {l:'ECOG',v:S.ecog||'â€”'},{l:'æ”¶æ¡ˆ',v:S.caseDate||'â€”'},
  ];
  document.getElementById('sum-patient').innerHTML = cells.map(c=>`<div class="sp"><span class="l">${c.l}</span><span class="v">${c.v}</span></div>`).join('');

  // Left-top: Diagnosis (compact inline)
  const dTags = [{l:'å‹æ…‹',v:TYPE_LABEL[S.type]||'â€”'},{l:'åˆ†æœŸ',v:S.stage||'â€”'}];
  if(needsMut(S.type)){ dTags.push({l:'çªè®Š',v:S.mutation||'â€”'}); }
  if(needsPdl1(S.type)){ dTags.push({l:'PD-L1',v:S.pdl1||'â€”'}); }
  document.getElementById('sum-diagnosis').innerHTML =
    `<div class="st"><i class="fa-solid fa-microscope"></i> è¨ºæ–·</div>` +
    `<div class="diag-row">${dTags.map(d=>`<span class="diag-tag"><span class="l">${d.l}</span><span class="v">${d.v}</span></span>`).join('')}</div>`;

  // Left-bottom: Checklist (incomplete only)
  const ckDone=Object.keys(S.ck||{}).length, ckTotal=CK.length, ckRemain=ckTotal-ckDone, ckPct=Math.round(ckDone/ckTotal*100);
  const ckC = ckPct===100?'var(--primary)':'var(--amber)';
  let ckH = `<div class="st"><i class="fa-solid fa-clipboard-check"></i> æª¢æŸ¥ <span style="font-family:'JetBrains Mono',monospace;color:${ckC};font-size:16px;font-weight:900;margin-left:4px">${ckDone}/${ckTotal}</span></div>`;
  ckH += `<div class="sbar"><div style="background:${ckC};width:${ckPct}%"></div></div>`;
  if(ckRemain===0){ ckH += '<div class="sck-ok"><i class="fa-solid fa-circle-check"></i>å…¨éƒ¨å®Œæˆ</div>'; }
  else {
    ckH += `<div style="font-size:13px;color:var(--rose);font-weight:600;margin-bottom:8px">âš  å°šæœ‰ ${ckRemain} é …æœªå®Œæˆ</div><div class="sck">`;
    CK.forEach(c=>{ if(!S.ck?.[c.id]) ckH += `<div class="sci"><i class="fa-solid fa-circle-xmark"></i>${c.l}</div>`; });
    ckH += '</div>';
  }
  document.getElementById('sum-checklist').innerHTML = ckH;

  // Right-top: Treatment
  let txH = '<div class="st"><i class="fa-solid fa-stethoscope"></i> æ²»ç™‚è·¯å¾‘</div>';
  if(S.type && S.stage){
    const fn=PW_SUMMARY[S.type]?.[S.stage]; const txt=fn?fn(S):'å°šç„¡å°æ‡‰è·¯å¾‘æ‘˜è¦';
    // â˜… CANCER-SPECIFIC: åˆ¤æ–·æ˜¯å¦æœ‰è‡ªè²»é …ç›®ï¼ˆæ›ç™Œåˆ¥æ™‚éœ€èª¿æ•´ï¼‰
    const self=(S.type==='SCLC'&&S.stage==='ES')||(S.mutation==='NONE'&&S.pdl1!=='>=50')||S.mutation==='OTHER';
    txH += `<div class="stx"><div class="tl">ğŸ¯ å»ºè­°æ–¹æ¡ˆ</div><div class="tv">${txt}</div></div>`;
    txH += `<div class="stx"><div class="tl">ğŸ’° è²»ç”¨æ¦‚ä¼°</div><div class="tv">${self?'éƒ¨åˆ†è‡ªè²»é …ç›®ï¼Œå»ºè­°ç¢ºèªä¿éšª':'ä»¥å¥ä¿çµ¦ä»˜ç‚ºä¸»'}</div></div>`;
  } else { txH += '<div style="padding:8px 0;color:var(--text3);font-size:15px">å°šæœªå®Œæˆæ±ºç­–</div>'; }
  document.getElementById('sum-treatment').innerHTML = txH;

  // Right-bottom: Notes
  let nH = '<div class="st"><i class="fa-solid fa-pen-to-square"></i> å‚™è¨»</div>';
  nH += S.notes ? `<div class="snote">${S.notes.replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>` : '<div class="snote-empty">ç„¡å‚™è¨»</div>';
  document.getElementById('sum-notes-box').innerHTML = nH;

  // Alerts
  // â˜… CANCER-SPECIFIC: ç·Šæ€¥è­¦ç¤ºé …ç›®ï¼ˆæ›ç™Œåˆ¥æ™‚éœ€èª¿æ•´ï¼‰
  const al=['ç™¼ç‡’ >38.5Â°C æˆ–å¯’é¡«','åŠ‡çƒˆèƒ¸ç—›æˆ–å’³è¡€å¢å¤š','å–˜ä¸éæ°£æˆ–æ„è­˜æ¨¡ç³Š','åš´é‡çš®è†šæ°´æ³¡æˆ–ç´…ç–¹'];
  document.getElementById('sum-alerts').innerHTML = `<span class="at">âš  ç·Šæ€¥è­¦è¨Š</span>` + al.map(a=>`<span class="ai"><i class="fa-solid fa-circle-exclamation"></i>${a}</span>`).join('<span class="as">â”‚</span>');
}

// â”€â”€ Checklist â”€â”€
function renderCK(){
  const el = document.getElementById('ck-list');
  // Group items by group name
  const groups = []; let lastG='';
  CK.forEach(item=>{
    if(item.g!==lastG){ groups.push({title:item.g, items:[]}); lastG=item.g; }
    groups[groups.length-1].items.push(item);
  });
  const mid = Math.ceil(groups.length/2);
  const cols = [groups.slice(0,mid), groups.slice(mid)];
  let html='';
  cols.forEach(colGroups=>{
    html+='<div class="ck-col">';
    colGroups.forEach(g=>{
      html+=`<div class="ck-grp"><div class="ck-grp-title">${g.title}</div><div class="ck-grp-items">`;
      g.items.forEach(item=>{
        const done = A.S.ck[item.id];
        html+=`<div class="ck-item${done?' done':''}" onclick="APP.toggleCK('${item.id}',this)"><div class="ck-box"><i class="fa-solid fa-check"></i></div><span class="ck-label">${item.l}</span></div>`;
      });
      html+='</div></div>';
    });
    html+='</div>';
  });
  el.innerHTML = html;
  updateCKBar();
}
A.toggleCK = function(id,el){
  if(A.S.ck[id]){ delete A.S.ck[id]; el.classList.remove('done'); }
  else{ const n=new Date(); A.S.ck[id]=`${n.getMonth()+1}/${n.getDate()} ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; el.classList.add('done'); }
  updateCKBar();
};
function updateCKBar(){
  const done=Object.keys(A.S.ck).length, total=CK.length, pct=Math.round(done/total*100);
  document.getElementById('ck-bar').style.width=pct+'%';
  document.getElementById('ck-pct').textContent=pct+'%';
  const b=document.getElementById('ck-badge'); const rem=total-done;
  if(rem>0){b.style.display='';b.textContent=rem;}else b.style.display='none';
}

// â”€â”€ Stats filter â”€â”€
let statRangeMode = 'all';
let curStatTab = 'overview';
A.statTab = function(tab){
  curStatTab = tab;
  document.querySelectorAll('.stat-tab').forEach(b=>b.classList.toggle('on',b.dataset.st===tab));
  document.querySelectorAll('.stat-pane').forEach(p=>p.classList.toggle('active',p.id==='sp-'+tab));
};
A.statRange = function(mode){
  statRangeMode = mode;
  document.querySelectorAll('[data-sf]').forEach(b=>b.classList.toggle('on',b.dataset.sf===mode));
  A.statRefresh();
};
A.statRefresh = function(){ loadStats(); };

function getFilteredRecords(recs){
  let filtered = recs;
  const now = new Date();
  // Date range
  if(statRangeMode==='month'){
    filtered = filtered.filter(r=>{ const d=new Date(r.caseDate||r.savedAt||r.created); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear(); });
  } else if(statRangeMode==='3m'){
    const cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth()-3);
    filtered = filtered.filter(r=>new Date(r.caseDate||r.savedAt||r.created)>=cutoff);
  } else if(statRangeMode==='6m'){
    const cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth()-6);
    filtered = filtered.filter(r=>new Date(r.caseDate||r.savedAt||r.created)>=cutoff);
  } else if(statRangeMode==='year'){
    filtered = filtered.filter(r=>new Date(r.caseDate||r.savedAt||r.created).getFullYear()===now.getFullYear());
  } else if(statRangeMode==='custom'){
    const from = document.getElementById('sf-from').value;
    const to = document.getElementById('sf-to').value;
    if(from) filtered = filtered.filter(r=>(r.caseDate||r.savedAt||r.created)>=from);
    if(to) filtered = filtered.filter(r=>(r.caseDate||r.savedAt||r.created)<=to+'T23:59:59');
  }
  // Type
  const tf = document.getElementById('sf-type').value;
  if(tf) filtered = filtered.filter(r=>r.type===tf);
  // Stage
  const sf = document.getElementById('sf-stage').value;
  if(sf) filtered = filtered.filter(r=>r.stage===sf);
  return filtered;
}

// â”€â”€ Stats render â”€â”€
let charts={};
async function loadStats(){
  const allRecs = await getAll('records');
  const recs = getFilteredRecords(allRecs);
  const n = recs.length;
  const now=new Date();
  const thisM=recs.filter(r=>{const d=new Date(r.caseDate||r.savedAt||r.created);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();});
  document.getElementById('stat-cards').innerHTML=`
    <div class="stat-card"><div class="stat-num">${n}</div><div class="stat-label">ç¯©é¸çµæœ</div></div>
    <div class="stat-card"><div class="stat-num">${allRecs.length}</div><div class="stat-label">ç¸½æ”¶æ¡ˆ</div></div>
    <div class="stat-card"><div class="stat-num">${recs.filter(r=>r.type===CFG.types[0].v).length}</div><div class="stat-label">${CFG.types[0].l}</div></div>
    <div class="stat-card"><div class="stat-num">${recs.filter(r=>r.stage==='IV'||r.stage==='ES').length}</div><div class="stat-label">æ™šæœŸ</div></div>`;
  const typeKeys=CFG.types.map(t=>t.v), typeLabels=CFG.types.map(t=>TYPE_LABEL[t.v]), typeColors=['#10b981','#f59e0b','#ef4444','#8b5cf6','#2563eb'];
  mkChart('ch-type','doughnut',typeLabels,typeKeys.map(k=>recs.filter(r=>r.type===k).length),typeColors.slice(0,typeKeys.length));
  const allStages=[...new Set(Object.values(STAGES).flat().map(s=>s.v))];
  mkChart('ch-stage','bar',allStages,allStages.map(s=>recs.filter(r=>r.stage===s).length),['#10b981','#f59e0b','#4f46e5','#ef4444','#dc2626'].slice(0,allStages.length));
  if(CFG.hasMutation){
    const mv=['EGFR','ALK','OTHER','NONE','PENDING','N/A'];
    mkChart('ch-mut','doughnut',mv,mv.map(m=>recs.filter(r=>r.mutation===m).length),['#10b981','#2563eb','#8b5cf6','#94a3b8','#fbbf24','#d1d5db']);
  }
  const mo={}; recs.forEach(r=>{const d=r.caseDate||r.savedAt||r.created; const k=d.substring(0,7); mo[k]=(mo[k]||0)+1;});
  const mk=Object.keys(mo).sort();
  mkChart('ch-trend','line',mk,mk.map(k=>mo[k]),['#2563eb']);

  // â”€â”€ Checklist completion stats â”€â”€
  if(n > 0){
    const ckRates = CK.map(item => {
      const done = recs.filter(r => r.ck && r.ck[item.id]).length;
      return { id:item.id, label:item.l, done, pct: Math.round(done/n*100) };
    }).sort((a,b) => a.pct - b.pct);
    const allComplete = recs.filter(r => r.ck && Object.keys(r.ck).length === CK.length).length;
    const avgItems = Math.round(recs.reduce((s,r) => s + (r.ck ? Object.keys(r.ck).length : 0), 0) / n * 10) / 10;
    const worst = ckRates[0];
    document.getElementById('ck-stat-cards').innerHTML = `
      <div class="stat-card"><div class="stat-num">${Math.round(allComplete/n*100)}%</div><div class="stat-label">å…¨æ•¸å®Œæˆç‡</div></div>
      <div class="stat-card"><div class="stat-num">${allComplete}/${n}</div><div class="stat-label">12é …å…¨å®Œæˆ</div></div>
      <div class="stat-card"><div class="stat-num">${avgItems}</div><div class="stat-label">å¹³å‡å®Œæˆé …æ•¸</div></div>
      <div class="stat-card"><div class="stat-num" style="font-size:18px;color:var(--rose)">${worst.pct}%</div><div class="stat-label">ç“¶é ¸ï¼š${worst.label}</div></div>`;
    document.getElementById('ck-stat-bars').innerHTML = ckRates.map(item => {
      const cls = item.pct>=70?'high':item.pct>=40?'mid':'low';
      const clr = item.pct>=70?'var(--primary)':item.pct>=40?'var(--amber)':'var(--rose)';
      return `<div class="ck-stat-row"><div class="ck-stat-label">${item.label}</div><div class="ck-stat-bar-wrap"><div class="ck-stat-bar-fill ${cls}" style="width:${item.pct}%"></div></div><div class="ck-stat-pct" style="color:${clr}">${item.pct}%</div></div>`;
    }).join('');
  } else {
    document.getElementById('ck-stat-cards').innerHTML='';
    document.getElementById('ck-stat-bars').innerHTML='<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">ç„¡è³‡æ–™</div>';
  }

  // â”€â”€ Cross table: type Ã— stage â”€â”€
  const types=CFG.types.map(t=>t.v);
  const stages=allStages;
  let maxVal=0;
  const grid={};
  types.forEach(t=>{ grid[t]={}; stages.forEach(s=>{ grid[t][s]=recs.filter(r=>r.type===t&&r.stage===s).length; if(grid[t][s]>maxVal)maxVal=grid[t][s]; }); });
  let ctHtml='<table class="cross-tbl"><thead><tr><th></th>';
  stages.forEach(s=>ctHtml+=`<th>${s}</th>`);
  ctHtml+='<th>åˆè¨ˆ</th></tr></thead><tbody>';
  types.forEach(t=>{
    const rowTotal=stages.reduce((s,st)=>s+grid[t][st],0);
    ctHtml+=`<tr><th>${TYPE_LABEL[t]}</th>`;
    stages.forEach(s=>{ const v=grid[t][s]; ctHtml+=`<td${v===maxVal&&v>0?' class="hi"':''}>${v}</td>`; });
    ctHtml+=`<td>${rowTotal}</td></tr>`;
  });
  const colTotals=stages.map(s=>types.reduce((sum,t)=>sum+grid[t][s],0));
  ctHtml+=`<tr><th>åˆè¨ˆ</th>${colTotals.map(v=>`<td>${v}</td>`).join('')}<td>${colTotals.reduce((a,b)=>a+b,0)}</td></tr>`;
  ctHtml+='</tbody></table>';
  document.getElementById('cross-table').innerHTML=ctHtml;

  // â”€â”€ Record table â”€â”€
  document.getElementById('stat-tbody').innerHTML=recs.sort((a,b)=>(b.caseDate||b.savedAt||b.created).localeCompare(a.caseDate||a.savedAt||a.created)).map(r=>`<tr style="border-bottom:1px solid var(--border)"><td style="padding:8px;font-family:'JetBrains Mono',monospace;font-size:12px">${r.caseDate||new Date(r.savedAt||r.created).toLocaleDateString('zh-TW')}</td><td style="padding:8px;font-weight:600">${r.code||'â€”'}</td><td style="padding:8px">${r.name||'â€”'}</td><td style="padding:8px">${TYPE_LABEL[r.type]||'â€”'}</td><td style="padding:8px">${r.stage||'â€”'}</td><td style="padding:8px">${r.mutation||'â€”'}</td><td style="padding:8px">${r.pdl1||'â€”'}</td><td style="padding:8px"><span style="font-family:'JetBrains Mono',monospace;font-size:12px;${r.ck&&Object.keys(r.ck).length===12?'color:var(--primary);font-weight:700':''}">${r.ck?Object.keys(r.ck).length:0}/12</span></td><td style="padding:8px"><button onclick="APP.del(${r.id},'saved')" style="color:var(--rose);font-size:12px;text-decoration:underline">åˆªé™¤</button> <button onclick="APP.load(${r.id},'saved')" style="color:var(--accent);font-size:12px;text-decoration:underline;margin-left:4px">ç·¨è¼¯</button></td></tr>`).join('');
}
function mkChart(id,type,labels,data,colors){
  if(charts[id])charts[id].destroy();
  const ctx=document.getElementById(id); if(!ctx)return;
  charts[id]=new Chart(ctx,{type,data:{labels,datasets:[{data,backgroundColor:type==='line'?'transparent':colors,borderColor:type==='line'?colors[0]:colors,borderWidth:type==='line'?3:1,tension:.4,pointRadius:type==='line'?4:0,pointBackgroundColor:type==='line'?colors[0]:undefined}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:type==='doughnut',position:'bottom',labels:{font:{size:11,family:'Noto Sans TC'}}}},scales:(type==='bar'||type==='line')?{y:{beginAtZero:true,ticks:{stepSize:1}}}:undefined}});
}

// â”€â”€ Export / Import â”€â”€
A.exportCSV = async function(){
  const r=await getAll('records'); if(!r.length){alert('ç„¡ç´€éŒ„');return;}
  const h=['æ”¶æ¡ˆæ—¥æœŸ','ä»£è™Ÿ','å§“å','æ€§åˆ¥','å‡ºç”Ÿæ—¥æœŸ','å¹´é½¡','ECOG','å‹æ…‹','åˆ†æœŸ','çªè®Š','PD-L1','æª¢æŸ¥å®Œæˆæ•¸','å‚™è¨»'];
  const rows=r.map(x=>{const age=calcAgeFromDates(x.birthday,x.caseDate); return [x.caseDate||new Date(x.savedAt||x.created).toLocaleDateString('zh-TW'),x.code,x.name||'',x.gender,x.birthday||'',age!==null?age:'',x.ecog,x.type,x.stage,x.mutation,x.pdl1,x.ck?Object.keys(x.ck).length:0,(x.notes||'').replace(/\n/g,' ')];});
  dl('\uFEFF'+[h,...rows].map(r=>r.map(c=>`"${c}"`).join(',')).join('\n'),CFG.id+'_records.csv','text/csv');
  await put('settings',{key:'lastExport',value:new Date().toISOString()});
};
A.exportJSON = async function(){
  const r=await getAll('records');
  dl(JSON.stringify(r,null,2),CFG.id+'_records.json','application/json');
  await put('settings',{key:'lastExport',value:new Date().toISOString()});
};
A.backupAll = async function(){
  const records=await getAll('records');
  const drafts=await getAll('drafts');
  const settings=await getAll('settings');
  const backup={version:2,exportedAt:new Date().toISOString(),records,drafts,settings};
  dl(JSON.stringify(backup,null,2),CFG.id+'_backup_'+todayStr()+'.json','application/json');
  await put('settings',{key:'lastExport',value:new Date().toISOString()});
  alert('âœ… å®Œæ•´å‚™ä»½å·²ä¸‹è¼‰ï¼ˆå«ç´€éŒ„ã€è‰ç¨¿ã€è¨­å®šï¼‰');
  loadBackupStatus();
};
A.handleRestore = async function(e){
  const f=e.target.files[0]; if(!f)return;
  try{
    const data=JSON.parse(await f.text());
    if(!data.records||!Array.isArray(data.records)) throw 0;
    if(!confirm(`ç¢ºå®šé‚„åŸï¼Ÿå°‡åŒ¯å…¥ ${data.records.length} ç­†ç´€éŒ„ã€${(data.drafts||[]).length} ç­†è‰ç¨¿ã€‚\nï¼ˆä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™ï¼Œé‡è¤‡ ID æœƒè¦†è“‹ï¼‰`)) return;
    for(const r of data.records){ await put('records',r); }
    for(const d of (data.drafts||[])){ await put('drafts',d); }
    for(const s of (data.settings||[])){ await put('settings',s); }
    alert(`âœ… é‚„åŸå®Œæˆ`);
    loadStats();
    loadBackupStatus();
  } catch{ alert('âŒ å‚™ä»½æª”æ ¼å¼éŒ¯èª¤'); }
  e.target.value='';
};
A.handleImport = async function(e){
  const f=e.target.files[0]; if(!f)return;
  try{ const d=JSON.parse(await f.text()); if(!Array.isArray(d))throw 0; for(const r of d){delete r.id; await put('records',r);} alert(`âœ… åŒ¯å…¥ ${d.length} ç­†`); loadStats(); loadBackupStatus(); }
  catch{alert('âŒ æ ¼å¼éŒ¯èª¤');}
  e.target.value='';
};
function dl(c,n,t){ const b=new Blob([c],{type:t}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u;a.download=n;a.click(); URL.revokeObjectURL(u); }

// â”€â”€ Backup status â”€â”€
async function loadBackupStatus(){
  try{
    const lastExp = await get('settings','lastExport');
    const el = document.getElementById('bk-last-time');
    if(lastExp){
      const d = new Date(lastExp.value);
      el.textContent = d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}) + ' ' + d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});
      const days = (Date.now() - d.getTime()) / 86400000;
      if(days > 30) document.getElementById('backup-warn').style.display='';
      else document.getElementById('backup-warn').style.display='none';
    } else {
      el.textContent = 'å¾æœªå‚™ä»½';
      const recs = await getAll('records');
      if(recs.length > 0) document.getElementById('backup-warn').style.display='';
    }
    // Also show record/draft counts
    const recs = await getAll('records');
    const drafts = await getAll('drafts');
    const statusEl = document.getElementById('bk-status');
    const existingCount = statusEl.querySelector('.bk-counts');
    if(existingCount) existingCount.remove();
    const countDiv = document.createElement('div');
    countDiv.className = 'bk-counts';
    countDiv.style.cssText = 'margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;gap:20px;font-size:13px;color:var(--text2)';
    countDiv.innerHTML = `<span><b style="color:var(--primary)">${recs.length}</b> ç­†ç´€éŒ„</span><span><b style="color:var(--amber)">${drafts.length}</b> ç­†è‰ç¨¿</span>`;
    statusEl.appendChild(countDiv);
  }catch(e){}
}

// â”€â”€ Touch swipe â”€â”€
let tx=0,ty=0;
document.querySelector('.content').addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
document.querySelector('.content').addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;if(Math.abs(dx)>80&&Math.abs(dx)>Math.abs(dy)*1.5){const i=PANELS.indexOf(cur);if(dx>0&&i>0)A.go(PANELS[i-1]);if(dx<0&&i<PANELS.length-1)A.go(PANELS[i+1]);}},{passive:true});

// â”€â”€ Init â”€â”€
async function boot(){
  await openDB();
  document.getElementById('topbar-date').textContent=new Date().toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'});
  document.getElementById('pt-casedate').value = todayStr();
  A.S.caseDate = todayStr();
  renderCK();
  updateBar();
  loadList();
  updateTitle();
}
boot();

})(APP);
</script>
</body>
</html>
